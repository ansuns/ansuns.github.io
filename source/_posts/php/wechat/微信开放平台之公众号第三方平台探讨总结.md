---
title: 微信开放平台之公众号第三方平台探讨总结
abbrlink: 2c7d08a0
date: 2015-08-26 16:32:15
tags:
  - 微信公众号
  - wechat
  - 微信开放平台
categories:
  - PHP
  - ThinkPHP
---
#### 1. 申请地址：[链接](https://open.weixin.qq.com/) ####

#### 2. 填写开发资料： ####

{% asset_img wechat1.png 填写开发资料 %}

 
说明：**授权事件接收URL**，用于获取微信服务器每10分钟推送的**ComponentVerifyTicket**，该Tikict用于和**appid**,**appscret**获取三方平台
的 **component_access_token**，而**component_access_token** 则用于获取预授权码**pre_auth_code**，授权码换取公众号的授权信，预授权码：
该API用于使用授权码换取授权公众号的授权信息，并换取**authorizer_access_token**和**authorizer_refresh_token**。 授权码的获取，需要
在用户在第三方平台授权页中完成授权流程后，在回调URI中通过URL参数提供给第三方平台方。授权成功会返回授权公众号的授权信息，值
得注意的是，**authorizer_refresh_token**必须保存好，**authorizer_refresh_token**是被授权公众号获取**authorizer_access_token**
（相当于普通的**access_token**）的凭证，否则需要重新授权才能获取。

#### 3. 配置 ####

如下：（注：所有消息收发均要加解密，主动调用的接口不包括）
```php
public function sysmessage()
{
    import("@.ORG.aes.WXBizMsgCrypt");
    $wxData = $this->weixin_account;
    $encodingAesKey = $wxData['encodingAesKey'];
    $token = $wxData['token'];
    $appId = $wxData['appId'];
    $timeStamp = empty($_GET['timestamp']) ? "" : trim($_GET['timestamp']);
    $nonce = empty($_GET['nonce']) ? "" : trim($_GET['nonce']);
    $msg_sign = empty($_GET['msg_signature']) ? "" : trim($_GET['msg_signature']);
    $encryptMsg = file_get_contents('php://input');
    $pc = new WXBizMsgCrypt($token, $encodingAesKey, $appId);

    $xml_tree = new DOMDocument();
    $xml_tree->loadXML($encryptMsg);
    $array_e = $xml_tree->getElementsByTagName('Encrypt');
    $encrypt = $array_e->item(0)->nodeValue;


    $format = "<xml><ToUserName><![CDATA[toUser]]></ToUserName><Encrypt><![CDATA[%s]]></Encrypt></xml>";
    $from_xml = sprintf($format, $encrypt);

    // 第三方收到公众号平台发送的消息
    $msg = '';
    $errCode = $pc->decryptMsg($msg_sign, $timeStamp, $nonce, $from_xml, $msg);
    if ($errCode == 0) {
        //print("解密后: " . $msg . "\n");
        $xml = new DOMDocument();
        $xml->loadXML($msg);
        $array_e = $xml->getElementsByTagName('ComponentVerifyTicket');
        $component_verify_ticket = $array_e->item(0)->nodeValue;

        //logResult('解密后的component_verify_ticket是：'.$component_verify_ticket);

        $dateline = time();
        $date_time = date('Y-m-d H:i:s', time());
        $data = array(
            'component_verify_ticket' => $component_verify_ticket,
            'token_expires' => $dateline + 600,
            'date_time' => $date_time,
        );
        $res = M('weixin_account')->where(array('appId' => $this->component_appid))->save($data);
        if ($res) {
            $weixin_account = M('weixin_account')->where(array('appId' => $this->component_appid))->find();
            S('weixin_account' . $this->component_appid, $weixin_account, 600);
            echo 'success';
        }

    } else {
        //logResult('解密后失败：'.$errCode);
        //$res = M('weixin_account')->where(array('appId'=>$this->component_appid))->save(array('text'=>'fasle'));
        print($errCode . "\n");
    }

    die();
}
```

>获取授权跳转链接：
```php
//获取授权回调URL
public function auth()
{
    if (IS_POST) {
        $pre_auth_code = $this->weObj->get_auth_code();
        $token = $this->weObj->getAccessToken();
        $callback = U('Index/oauth_back', '', true, false, true);
        $url = $this->weObj->getRedirect($callback, $pre_auth_code);
        $this->ajaxReturn($url);
    } else {
        $this->ajaxReturn('error');
    }

}
```

格式：
```html
<a href="https://mp.weixin.qq.com/cgi-bin/componentloginpage?component_appid=wx07068eax27ef6eed&pre_auth_code=preauthcode@@@lVMrqq7UdbhIQj1-IwlrtYSXIoIghSSgPrWQmSgzSVChVdQJgJ2iAInQOqURpqFU&redirect_uri=http%3A%2F%2Fsmg.xxx.cn%2Findex.php%3Fg%3DUser%26m%3DIndex%26a%3Doauth_back" id="authurl" style="display: inline;">
```
![](https://open.weixin.qq.com/zh_CN/htmledition/res/assets/res-design-download/icon_button3_1.png)
　　

点击进行授权：

{% asset_img wechat2.png 进行授权 %}

再点击登陆并且授权的时候，会要求用管理员微信扫一扫确认授权。

授权成功后就得到被授权公众号的授权信息了，包括**appId**，**authorizer_access_token**，**authorizer_refresh_token**，
头像，公众号类型等信息，其中**authorizer_refresh_token**必须完整保存好。

这样就可以完成一个公众号的授权了。

#### 3. 处理消息 ####

```php
//公众号消息与事件接收URL
//此处为示例，逻辑需要自己处理，（注意加解密）
public function eventmsg()
{
    import("@.ORG.aes.WXBizMsgCrypt");
    $wxData = $this->weixin_account;
    $encodingAesKey = $wxData['encodingAesKey'];
    $token = $wxData['token'];
    $appId = $wxData['appId'];
    $timeStamp = empty($_GET['timestamp']) ? "" : trim($_GET['timestamp']);
    $nonce = empty($_GET['nonce']) ? "" : trim($_GET['nonce']);
    $msg_sign = empty($_GET['msg_signature']) ? "" : trim($_GET['msg_signature']);

    $encryptMsg = file_get_contents('php://input');
    $pc = new WXBizMsgCrypt($token, $encodingAesKey, $appId);

    $xml_tree = new DOMDocument();
    $xml_tree->loadXML($encryptMsg);
    $array_e = $xml_tree->getElementsByTagName('Encrypt');
    $encrypt = $array_e->item(0)->nodeValue;


    $format = "<xml><ToUserName><![CDATA[toUser]]></ToUserName><Encrypt><![CDATA[%s]]></Encrypt></xml>";
    $from_xml = sprintf($format, $encrypt);
    // 第三方收到公众号平台发送的消息
    $msg = '';
    $errCode = $pc->decryptMsg($msg_sign, $timeStamp, $nonce, $from_xml, $msg);

    if ($errCode == 0) {
        //print("解密后: " . $msg . "\n");
        $xml = new DOMDocument();
        $xml->loadXML($msg);

        $array_e = $xml->getElementsByTagName('Content');
        $content = $array_e->item(0)->nodeValue;

        $array_e2 = $xml->getElementsByTagName('ToUserName');
        $ToUserName = $array_e2->item(0)->nodeValue;

        $array_e3 = $xml->getElementsByTagName('FromUserName');
        $FromUserName = $array_e3->item(0)->nodeValue;

        $array_e5 = $xml->getElementsByTagName('MsgType');
        $MsgType = $array_e5->item(0)->nodeValue;

        //加密消息
        $encryptMsg = '';
        $text = "<xml>
					<ToUserName><![CDATA[$FromUserName]]></ToUserName>
					<FromUserName><![CDATA[$ToUserName]]></FromUserName>
					<CreateTime>$stime</CreateTime>
					<MsgType><![CDATA[text]]></MsgType>
					<Content><![CDATA[$contentx]]></Content>
					</xml>";

        $errCode = $pc->encryptMsg($text, $timeStamp, $nonce, $encryptMsg);
        echo $encryptMsg;
        exit();


    } else {
        print($errCode . "\n");
        exit();
    }
} 
```   
　　到此授权基本完成了。

 

#### 4. 全网发布检测 ####

```php
if ($MsgType == "text") {
    $needle = 'QUERY_AUTH_CODE:';
    $tmparray = explode($needle, $content);
    if (count($tmparray) > 1) {
        //3、模拟粉丝发送文本消息给专用测试公众号，第三方平台方需在5秒内返回空串
        //表明暂时不回复，然后再立即使用客服消息接口发送消息回复粉丝                                
        $contentx = str_replace($needle, '', $content);
        $info = $this->weObj->get_authorization_info($contentx);
        $test_token = $info['authorizer_access_token'];
        $content_re = $contentx . "_from_api";
        echo '';
        $data = '{
                            "touser":"' . $FromUserName . '",
                            "msgtype":"text",
                            "text":
                            {
                                 "content":"' . $content_re . '"
                            }
                        }';
        $url = "https://api.weixin.qq.com/cgi-bin/message/custom/send?access_token=" . $test_token;
        $this->https_post($url, $data);

    } else {
        //2、模拟粉丝发送文本消息给专用测试公众号
        $contentx = "TESTCOMPONENT_MSG_TYPE_TEXT_callback";
    }
}

//1、模拟粉丝触发专用测试公众号的事件
if ($MsgType == "event") {
    $array_e4 = $xml->getElementsByTagName('Event');
    $event = $array_e4->item(0)->nodeValue;
    $contentx = $event . "from_callback";

}
```
 
效果：
{% asset_img wechat3.png 效果 %}

检测
{% asset_img wechat4.png 检测 %}

成功
{% asset_img wechat5.png 成功 %}

到此**全网发布**完成

 

