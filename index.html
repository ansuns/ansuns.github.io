<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta name="description" content="阿深">
<meta name="keywords" content="阿深">
<meta property="og:type" content="website">
<meta property="og:title" content="阿深">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="阿深">
<meta property="og:description" content="阿深">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="阿深">
<meta name="twitter:description" content="阿深">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/">





  <title>阿深</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">阿深</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">阿深</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-life">
          <a href="/life" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-life-buoy"></i> <br>
            
            生活
          </a>
        </li>
      
        
        <li class="menu-item menu-item-photo">
          <a href="/photo" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-photo"></i> <br>
            
            图片
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/p/2293fa6a/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="阿深">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/head3.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="阿深">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/p/2293fa6a/" itemprop="url">centos7部署lnmp环境</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-07-13T20:05:07+08:00">
                2019-07-13
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/服务/" itemprop="url" rel="index">
                    <span itemprop="name">服务</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/服务/部署/" itemprop="url" rel="index">
                    <span itemprop="name">部署</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>#1. 准备编译环境</p>
<ul>
<li><p>关闭防火墙<br>运行<br><code>systemctl status firewalld</code>命令查看当前防火墙的状态。</p>
<img src="/p/2293fa6a/1.png">
<p>i. </p>
</li>
<li><p>如果防火墙的状态参数是inactive，则防火墙为关闭状态。</p>
</li>
<li><p>如果防火墙的状态参数是active，则防火墙为开启状态。本示例中防火墙为开启状态，因此需要关闭防火墙。<br>ii. 关闭防火墙。如果防火墙为关闭状态可以忽略此步骤。</p>
</li>
<li><p>如果您想临时关闭防火墙，运行命令<code>systemctl stop firewalld</code>。</p>
<blockquote>
<p>说明 这只是暂时关闭防火墙，下次重启Linux后，防火墙还会开启。</p>
</blockquote>
</li>
<li><p>如果您想永久关闭防火墙，运行命令<code>systemctl disable firewalld</code>。</p>
<blockquote>
<p>说明 如果您想重新开启防火墙，请参见<strong>firewalld</strong>官网信息。</p>
</blockquote>
</li>
</ul>
<p>关闭SELinux。<br>运行<code>getenforce</code>命令查看SELinux的当前状态。</p>
<img src="/p/2293fa6a/2.png">

<p>ii. </p>
<ul>
<li>如果SELinux状态参数是Disabled， 则SELinux为关闭状态。</li>
<li>如果SELinux状态参数是Enforcing，则SELinux为开启状态。本示例中SELinux为开启状态，因此需要关闭SELinux。</li>
</ul>
<p>iii. 关闭SELinux。如果SELinux为关闭状态可以忽略此步骤。</p>
<ul>
<li>如果您想临时关闭SELinux，运行命令setenforce 0。</li>
</ul>
<blockquote>
<p>说明 这只是暂时关闭SELinux，下次重启Linux后，SELinux还会开启。</p>
</blockquote>
<ul>
<li><p>如果您想永久关闭SELinux，运行命令<code>vi /etc/selinux/config</code>编辑SELinux配置文件。回车后，把光标移动到SELINUX=enforcing这<br>一行，按i键进入编辑模式，修改为<code>SELINUX=disabled</code>， 按Esc键，然后输入:wq并按Enter键以保存并关闭SELinux配置文件。</p>
<blockquote>
<p>说明 如果您想重新开启SELinux，请参见SELinux的官方文档。</p>
</blockquote>
</li>
<li><p>查看关闭状态</p>
<img src="/p/2293fa6a/3.png">
</li>
<li><p>重启系统使设置生效。</p>
</li>
</ul>
<ul>
<li>下载软件：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">wget -c https://www.php.net/distributions/php-7.3.8.tar.gz</span><br><span class="line">wget -c http://nginx.org/download/nginx-1.16.1.tar.gz</span><br><span class="line">wget -c https://ftp.pcre.org/pub/pcre/pcre-8.42.tar.gz</span><br><span class="line">wget -c https://mirrors.tuna.tsinghua.edu.cn/mysql/downloads/MySQL-5.7/mysql-5.7.25.tar.gz</span><br><span class="line">wget -c http://mirrors.163.com/mysql/Downloads/MySQL-5.7/mysql-boost-5.7.27.tar.gz</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>#2. 安装Nginx<br>安装编译环境</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install gcc pcre pcre-devel zlib zlib-devel openssl openssl-devel</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">groupadd www <span class="comment"># 添加用户组</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">useradd www -g www -s /sbin/nologin -M <span class="comment">#-M 不要自动建立用户的登入目录 -g指定用户组</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf pcre.gz</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mv pcre-8.42 /usr/src/pcre-8.42</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/lcaol/src/nginx-1.16.1</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">./configure \</span><br><span class="line">--prefix=/usr/<span class="built_in">local</span>/nginx \</span><br><span class="line">--sbin-path=/usr/<span class="built_in">local</span>/nginx/nginx \</span><br><span class="line">--conf-path=/usr/<span class="built_in">local</span>/nginx/nginx.conf \</span><br><span class="line">--pid-path=/usr/<span class="built_in">local</span>/nginx/nginx.pid \</span><br><span class="line">--user=www \</span><br><span class="line">--group=www \</span><br><span class="line">--with-http_ssl_module \</span><br></pre></td></tr></table></figure>

<blockquote>
<p>–with-pcre=/usr/src/pcre-8.42 # 不手动指定</p>
</blockquote>
<p>编译安装</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>

<p>启动</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/nginx/nginx</span><br></pre></td></tr></table></figure>

<img src="/p/2293fa6a/4.png">

<blockquote>
<p>参考资料</p>
<ul>
<li><a href="https://www.bfshu.com/jcaz/123" target="_blank" rel="noopener">centos7.2源码编译安装LNMP</a></li>
<li><a href="http://www.dohooe.com/2016/03/03/352.html" target="_blank" rel="noopener">centos 7.x编写开机启动服务</a></li>
<li><a href="https://www.jianshu.com/p/ca5ee5f7075c" target="_blank" rel="noopener">CentOS7设置nginx开机自启动</a></li>
</ul>
</blockquote>
<p>1、在系统服务目录里创建nginx.service文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/lib/systemd/system/nginx.service</span><br></pre></td></tr></table></figure>

<p>2、写入内容如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#nginx服务配置到该文件中</span></span><br><span class="line"><span class="comment">#服务描述性的配置</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=nginx - high performance web server</span><br><span class="line">Documentation=http://nginx.org/en/docs/</span><br><span class="line">After=network.target remote-fs.target nss-lookup.target</span><br><span class="line"><span class="comment">#服务关键配置</span></span><br><span class="line">[Service]</span><br><span class="line">Type=forking</span><br><span class="line"><span class="comment">#pid文件位置 </span></span><br><span class="line"><span class="comment">#要与nginx配置文件中的pid配置路径一致，这个很重要，否则会服务启动失败</span></span><br><span class="line">PIDFile=/usr/<span class="built_in">local</span>/nginx/nginx.pid</span><br><span class="line"><span class="comment">#启动前检测 nginx配置文件 是否正确</span></span><br><span class="line">ExecStartPre=/usr/<span class="built_in">local</span>/nginx/nginx -t -c /usr/<span class="built_in">local</span>/nginx/nginx.conf</span><br><span class="line"><span class="comment">#启动</span></span><br><span class="line">ExecStart=/usr/<span class="built_in">local</span>/nginx/nginx -c /usr/<span class="built_in">local</span>/nginx/nginx.conf</span><br><span class="line"><span class="comment">#重启</span></span><br><span class="line">ExecReload=/bin/<span class="built_in">kill</span> -s HUP <span class="variable">$MAINPID</span></span><br><span class="line"><span class="comment">#关闭</span></span><br><span class="line">ExecStop=/bin/<span class="built_in">kill</span> -s QUIT <span class="variable">$MAINPID</span></span><br><span class="line">PrivateTmp=<span class="literal">true</span></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>

<p>保存退出。</p>
<ul>
<li><strong>Description</strong>：描述服务</li>
</ul>
<p><strong>After</strong>描述服务类别</p>
<ul>
<li>[Service]服务运行参数的设置</li>
<li><strong>Type=forking</strong>：是后台运行的形式</li>
<li><strong>ExecStart</strong>：为服务的具体运行命令</li>
<li><strong>ExecReload</strong>：为重启命令</li>
<li><strong>ExecStop</strong>：为停止命令</li>
<li><strong>PrivateTmp=True</strong>：表示给服务分配独立的临时空间</li>
<li>注意：[Service]的启动、重启、停止命令全部要求使用绝对路径<br>[Install]运行级别下服务安装的相关设置，可设置为多用户，即系统运行级别为3</li>
</ul>
<p>2.设置开机启动</p>
<ul>
<li><code>systemctl enable nginx.service</code></li>
</ul>
<p>3.其它命令</p>
<ul>
<li><code>systemctl start nginx.service</code> 　#启动nginx服务</li>
<li><code>systemctl enable nginx.service</code>　#设置开机自启动</li>
<li><code>systemctl disable nginx.service</code>　#停止开机自启动</li>
<li><code>systemctl status nginx.service</code>　#查看服务当前状态</li>
<li><code>systemctl restart nginx.service</code>　#重新启动服务</li>
<li>systemctl list-units –type=service`　#查看所有已启动的服务</li>
</ul>
<p>停止nginx</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/nginx/nginx -s stop</span><br></pre></td></tr></table></figure>

<p>创建软链接</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ln -s /usr/<span class="built_in">local</span>/nginx/nginx /usr/bin/nginx</span><br></pre></td></tr></table></figure>

<p>#3. MySQL安装<br>1、检查是否安装mariadb如安装则卸载</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum list installed | grep mariadb</span><br></pre></td></tr></table></figure>

<img src="/p/2293fa6a/5.png">

<blockquote>
<p>删除</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y remove mariadb* boost-*</span><br></pre></td></tr></table></figure>

<img src="/p/2293fa6a/6.png">

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/src/mysql-5.7.27/</span><br></pre></td></tr></table></figure>

<p>2、安装依赖包</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y cmake make gcc gcc-c++ bison ncurses ncurses-devel</span><br></pre></td></tr></table></figure>

<p>新建MySQL用户和用户组</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">groupadd -r mysql &amp;&amp; useradd -r -g mysql -s /sbin/nologin -M mysql</span><br></pre></td></tr></table></figure>

<p>创建目录</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@centosGome ~]<span class="comment"># mkdir -vp /usr/mysql/&#123;data,log,temp&#125; #或分别依次创建</span></span><br><span class="line">mkdir: 已创建目录 <span class="string">"/usr/mysql"</span></span><br><span class="line">mkdir: 已创建目录 <span class="string">"/usr/mysql/data"</span> <span class="comment">#数据存储目录</span></span><br><span class="line">mkdir: 已创建目录 <span class="string">"/usr/mysql/log"</span> <span class="comment">#日志目录</span></span><br><span class="line">mkdir: 已创建目录 <span class="string">"/usr/mysql/temp"</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chown -R mysql:mysql /usr/mysql <span class="comment"># root用户将mysql目录归mysql用户所有</span></span><br></pre></td></tr></table></figure>

<p>如果不带Boots的mysql包，下载</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget http://downloads.sourceforge.net/project/boost/boost/1.59.0/boost_1_59_0.tar.gz</span><br></pre></td></tr></table></figure>

<p>路径DWITH_BOOST修改为boots包的解压路径<br>接下来 预编译</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">cmake -DCMAKE_INSTALL_PREFIX=/usr/<span class="built_in">local</span>/mysql \</span><br><span class="line">-DMYSQL_DATADIR=/usr/<span class="built_in">local</span>/mysql/data \</span><br><span class="line">-DDOWNLOAD_BOOST=1 \</span><br><span class="line">-DWITH_BOOST=boost \</span><br><span class="line">-DSYSCONFDIR=/etc \</span><br><span class="line">-DWITH_MYISAM_STORAGE_ENGINE=1 \</span><br><span class="line">-DWITH_INNOBASE_STORAGE_ENGINE=1 \</span><br><span class="line">-DWITH_MEMORY_STORAGE_ENGINE=1 \</span><br><span class="line">-DWITH_ARCHIVE_STORAGE_ENGINE=1 \</span><br><span class="line">-DWITH_FEDERATED_STORAGE_ENGINE=1 \</span><br><span class="line">-DWITH_BLACKHOLE_STORAGE_ENGINE=1 \</span><br><span class="line">-DWITH_PARTITION_STORAGE_ENGINE=1 \</span><br><span class="line">-DWITH_READLINE=1 \</span><br><span class="line">-DMYSQL_UNIX_ADDR=/usr/<span class="built_in">local</span>/mysql/mysql.sock \</span><br><span class="line">-DMYSQL_TCP_PORT=3306 \</span><br><span class="line">-DENABLED_LOCAL_INFILE=1 \</span><br><span class="line">-DENABLE_DTRACE=0 \</span><br><span class="line">-DEXTRA_CHARSETS=all \</span><br><span class="line">-DDEFAULT_CHARSET=utf8mb4 \</span><br><span class="line">-DDEFAULT_COLLATION=utf8mb4_general_ci \</span><br><span class="line">-DMYSQL_USER=mysql</span><br></pre></td></tr></table></figure>

<p>配置解释：<br>-DCMAKE_INSTALL_PREFIX=/usr/local/mysql    //设置安装目录<br>-DMYSQL_DATADIR=/home/mysql/data     //设置数据库存放目录<br>-DMYSQL_UNIX_ADDR=/usr/local/mysql/mysql.sock   //设置UNIX socket目录<br>-DDEFAULT_CHARSET=utf8mb4     //设置默认字符集<br>-DDEFAULT_COLLATION=utf8mb4_general_ci     //设置默认校对规则<br>-DWITH_INNOBASE_STORAGE_ENGINE=1    //添加InnoDB引擎支持<br>-DSYSCONFDIR=/etc    //设置my.cnf配置文件的所在目录，默认为安装目录<br>编译安装</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>

<p>尴尬了，虚拟机空间不足：</p>
<img src="/p/2293fa6a/7.png">
<p>拷贝vdi到新目录执行命令：<br>VBoxManage internalcommands sethduuid “D:\VirtualBox VMs\centos7Gome\centos7Gome.vdi”</p>
<p>解决后继续：</p>
<p>cmake执行完的结果</p>
<img src="/p/2293fa6a/8.png">
<p>使用make命令进行编译，接下来你将经历漫长的等待</p>
<p>安装完成</p>
<img src="/p/2293fa6a/9.png">

<h5 id="拷贝可执行文件到指定的目录下，并修改名字为mysqld"><a href="#拷贝可执行文件到指定的目录下，并修改名字为mysqld" class="headerlink" title="拷贝可执行文件到指定的目录下，并修改名字为mysqld"></a>拷贝可执行文件到指定的目录下，并修改名字为mysqld</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp /usr/<span class="built_in">local</span>/mysql/support-files/mysql.server /etc/init.d/mysqld <span class="comment">#授予可执行的权限</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod +x /etc/init.d/mysqld <span class="comment">#设置为开机启动 systemctl enable mysqld</span></span><br></pre></td></tr></table></figure>

<p>添加环境变量</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/profile<span class="comment">#末尾添加以下内容#mysql env</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:/usr/<span class="built_in">local</span>/mysql/bin:/usr/<span class="built_in">local</span>/mysql/lib</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> /etc/profile</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#参考，具体里面的参数说明，请自行网上搜索</span></span><br><span class="line">[mysqld]</span><br><span class="line">character-set-server = utf8mb4</span><br><span class="line">collation-server = utf8mb4_general_ci</span><br><span class="line"></span><br><span class="line">skip-external-locking</span><br><span class="line">skip-name-resolve</span><br><span class="line"></span><br><span class="line">user = mysql</span><br><span class="line">port = 3306</span><br><span class="line"></span><br><span class="line">basedir = /usr/<span class="built_in">local</span>/mysql</span><br><span class="line">datadir = /usr/mysql/data</span><br><span class="line">tmpdir = /usr/mysql/temp</span><br><span class="line"><span class="comment"># server_id = .....</span></span><br><span class="line">socket = /usr/<span class="built_in">local</span>/mysql/mysql.sock</span><br><span class="line"><span class="built_in">log</span>-error = /usr/mysql/<span class="built_in">log</span>/mysql_error.log</span><br><span class="line">pid-file = /usr/mysql/data/mysql.pid</span><br><span class="line"></span><br><span class="line">open_files_limit = 10240</span><br><span class="line"></span><br><span class="line">back_log = 600</span><br><span class="line">max_connections=500</span><br><span class="line">max_connect_errors = 6000</span><br><span class="line">wait_timeout=605800</span><br><span class="line"></span><br><span class="line"><span class="comment">#open_tables = 600</span></span><br><span class="line"><span class="comment">#table_cache = 650</span></span><br><span class="line"><span class="comment">#opened_tables = 630</span></span><br><span class="line"></span><br><span class="line">max_allowed_packet = 32M</span><br><span class="line"></span><br><span class="line">sort_buffer_size = 4M</span><br><span class="line">join_buffer_size = 4M</span><br><span class="line">thread_cache_size = 300</span><br><span class="line">query_cache_type = 1</span><br><span class="line">query_cache_size = 256M</span><br><span class="line">query_cache_limit = 2M</span><br><span class="line">query_cache_min_res_unit = 16k</span><br><span class="line"></span><br><span class="line">tmp_table_size = 256M</span><br><span class="line">max_heap_table_size = 256M</span><br><span class="line"></span><br><span class="line">key_buffer_size = 256M</span><br><span class="line">read_buffer_size = 1M</span><br><span class="line">read_rnd_buffer_size = 16M</span><br><span class="line">bulk_insert_buffer_size = 64M</span><br><span class="line"></span><br><span class="line">lower_case_table_names=1</span><br><span class="line"></span><br><span class="line">default-storage-engine = INNODB</span><br><span class="line"></span><br><span class="line">innodb_buffer_pool_size = 1G</span><br><span class="line">innodb_log_buffer_size = 32M</span><br><span class="line">innodb_log_file_size = 128M</span><br><span class="line">innodb_flush_method = O_DIRECT</span><br><span class="line"></span><br><span class="line"><span class="comment">#####################</span></span><br><span class="line">long_query_time= 2</span><br><span class="line">slow-query-log = on</span><br><span class="line">slow-query-log-file = /usr/mysql/<span class="built_in">log</span>/mysql-slow.log</span><br><span class="line"></span><br><span class="line">[mysqldump]</span><br><span class="line">quick</span><br><span class="line">max_allowed_packet = 32M</span><br><span class="line"></span><br><span class="line">[mysqld_safe]</span><br><span class="line"><span class="built_in">log</span>-error=/var/<span class="built_in">log</span>/mysqld.log</span><br><span class="line">pid-file=/var/run/mysqld/mysqld.pid</span><br></pre></td></tr></table></figure>

<blockquote>
<p>参考资料<br><a href="https://my.oschina.net/u/1429136/blog/738772" target="_blank" rel="noopener">在CentOS7上编译安装MySQL 5.7</a><br><a href="https://www.jianshu.com/p/95a103add722" target="_blank" rel="noopener">在CentOS7上编译安装MySQL 5.7.13步骤详解</a><br><a href="https://www.bfshu.com/jcaz/123" target="_blank" rel="noopener">centos7.2源码编译安装LNMP</a></p>
</blockquote>
<p>初始化数据库 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqld --initialize-insecure --user=mysql --basedir=/usr/<span class="built_in">local</span>/mysql --datadir=/usr/mysql/data</span><br></pre></td></tr></table></figure>

<p>启动数据库：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start mysqld</span><br></pre></td></tr></table></figure>

<p>查看mysqld服务状态：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl status mysqld</span><br></pre></td></tr></table></figure>

<img src="/p/2293fa6a/10.png">

<img src="/p/2293fa6a/11.png">

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">设置数据库root用户密码</span><br><span class="line">　　MySQL和Oracle数据库一样，数据库也默认自带了一个 root 用户（这个和当前Linux主机上的root用户是完全不搭边的），我们在设置好</span><br><span class="line">MySQL数据库的安全配置后初始化root用户的密码。配制过程中，一路输入 y 就行了。这里只说明下MySQL5.7.14版本中，用户密码策略分成</span><br><span class="line">低级 LOW 、中等 MEDIUM 和超强 STRONG 三种，推荐使用中等 MEDIUM 级别！</span><br><span class="line">mysql_secure_installation*</span><br><span class="line">设置中等的话，一般是</span><br><span class="line">至少长度为8包涵大小写字母和数字和特殊字符的密码</span><br><span class="line">Qwerty.1234</span><br></pre></td></tr></table></figure>

<p>#4. 安装PHP</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">安装php-fpm</span><br><span class="line">Nginx本身不能处理PHP，作为web服务器，当它接收到请求后，不支持对外部程序的直接调用或者解析，必须通过FastCGI进行调用。如果是</span><br><span class="line">PHP请求，则交给PHP解释器处理，并把结果返回给客户端。PHP-FPM是支持解析php的一个FastCGI进程管理器。提供了更好管理PHP进程的</span><br><span class="line">方式，可以有效控制内存和进程、可以平滑重载PHP配置。</span><br></pre></td></tr></table></figure>

<p>1、安装依赖包</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install php-mcrypt libmcrypt libmcrypt-devel  autoconf  freetype gd libmcrypt libpng libpng-devel libjpeg libxml2 libxml2-devel zlib curl curl-devel re2c net-snmp-devel libjpeg-devel php-ldap openldap-devel openldap-servers openldap-clients freetype-devel gmp-devel</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/src/php-7.3.8/</span><br></pre></td></tr></table></figure>

<p>可能错误1:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">error：configure: error: Cannot find ldap libraries <span class="keyword">in</span> /usr/lib</span><br></pre></td></tr></table></figure>

<blockquote>
<p>解决方案：可能的原因是安装了64位的系统，在lib64下面有这个文件，可能在lib这文件夹里面没有，所以强制复制一次。</p>
<figure class="highlight plain"><figcaption><span>-frp</span><a href="/usr/lib64/libldap*">/usr/lib/```</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">可能错误2:</span><br><span class="line">```bash</span><br><span class="line">configure: error: Please reinstall the libzip distribution</span><br></pre></td></tr></table></figure>
</blockquote>
<img src="/p/2293fa6a/12.png">

<blockquote>
<p>解决方案：</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#先删除旧版本</span></span><br><span class="line">yum remove -y libzip</span><br><span class="line"><span class="comment">#下载编译安装</span></span><br><span class="line">wget https://nih.at/libzip/libzip-1.2.0.tar.gz</span><br><span class="line">tar -zxvf libzip-1.2.0.tar.gz</span><br><span class="line"><span class="built_in">cd</span> libzip-1.2.0</span><br><span class="line">./configure</span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>

<p>可能错误3</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">configure: error: Please reinstall the libzip distribution</span><br></pre></td></tr></table></figure>

<blockquote>
<p>解决方案：</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">wget https://nih.at/libzip/libzip-1.2.0.tar.gz</span><br><span class="line">tar -zxvf libzip-1.2.0.tar.gz</span><br><span class="line"><span class="built_in">cd</span> libzip-1.2.0</span><br><span class="line">./configure</span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>

<p>可能错误4</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">configure: error: off_t undefined; check your library configuration</span><br></pre></td></tr></table></figure>

<blockquote>
<p>解决方案：</p>
<blockquote>
<p>添加搜索路径到配置文件</p>
</blockquote>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">'/usr/local/lib64</span></span><br><span class="line"><span class="string">/usr/local/lib</span></span><br><span class="line"><span class="string">/usr/lib</span></span><br><span class="line"><span class="string">/usr/lib64'</span>&gt;&gt;/etc/ld.so.conf</span><br></pre></td></tr></table></figure>

<blockquote>
<blockquote>
<p>更新配置</p>
</blockquote>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ldconfig -v</span><br></pre></td></tr></table></figure>

<p>可能错误5</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/include/zip.h:59:21: fatal error: zipconf.h: No such file or dire</span><br></pre></td></tr></table></figure>

<blockquote>
<p>解决方案：手动复制过去</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp /usr/<span class="built_in">local</span>/lib/libzip/include/zipconf.h /usr/<span class="built_in">local</span>/include/zipconf.h</span><br></pre></td></tr></table></figure>

<p>预编译</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">./configure --prefix=/usr/<span class="built_in">local</span>/php \</span><br><span class="line">--with-config-file-path=/usr/<span class="built_in">local</span>/php/etc \</span><br><span class="line">--with-mysqli \</span><br><span class="line">--with-pdo-mysql \</span><br><span class="line">--with-mysql-sock=/usr/<span class="built_in">local</span>/mysql/mysql.sock \</span><br><span class="line">--with-iconv-dir \</span><br><span class="line">--with-freetype-dir \</span><br><span class="line">--with-jpeg-dir \</span><br><span class="line">--with-png-dir \</span><br><span class="line">--with-curl \</span><br><span class="line">--with-gd \</span><br><span class="line">--with-gmp \</span><br><span class="line">--with-zlib \</span><br><span class="line">--with-xmlrpc \</span><br><span class="line">--with-openssl \</span><br><span class="line">--without-pear \</span><br><span class="line">--with-snmp \</span><br><span class="line">--with-gettext \</span><br><span class="line">--with-mhash \</span><br><span class="line">--with-libxml-dir=/usr \</span><br><span class="line">--with-ldap \</span><br><span class="line">--with-ldap-sasl \</span><br><span class="line">--with-fpm-user=www \</span><br><span class="line">--with-fpm-group=www \</span><br><span class="line">--<span class="built_in">enable</span>-xml \</span><br><span class="line">--<span class="built_in">enable</span>-fpm  \</span><br><span class="line">--<span class="built_in">enable</span>-ftp \</span><br><span class="line">--<span class="built_in">enable</span>-bcmath \</span><br><span class="line">--<span class="built_in">enable</span>-soap \</span><br><span class="line">--<span class="built_in">enable</span>-shmop \</span><br><span class="line">--<span class="built_in">enable</span>-sysvsem \</span><br><span class="line">--<span class="built_in">enable</span>-sockets \</span><br><span class="line">--<span class="built_in">enable</span>-inline-optimization \</span><br><span class="line">--<span class="built_in">enable</span>-maintainer-zts \</span><br><span class="line">--<span class="built_in">enable</span>-mbregex \</span><br><span class="line">--<span class="built_in">enable</span>-mbstring \</span><br><span class="line">--<span class="built_in">enable</span>-pcntl \</span><br><span class="line">--<span class="built_in">enable</span>-zip \</span><br><span class="line">--<span class="built_in">disable</span>-fileinfo \</span><br><span class="line">--<span class="built_in">disable</span>-rpath \</span><br><span class="line">--<span class="built_in">enable</span>-libxml \</span><br><span class="line">--<span class="built_in">enable</span>-opcache \</span><br><span class="line">--<span class="built_in">enable</span>-mysqlnd</span><br></pre></td></tr></table></figure>

<p>预编译结果：</p>
<p>编译安装：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>

<p>安装错误</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/usr/bin/ld: ext/ldap/.libs/ldap.o: undefined reference to symbol <span class="string">'ber_strdup'</span></span><br><span class="line">//usr/lib64/liblber-2.4.so.2: error adding symbols: DSO missing from <span class="built_in">command</span> line</span><br><span class="line">collect2: error: ld returned 1 <span class="built_in">exit</span> status</span><br><span class="line">make: *** [sapi/cli/php] 错误 1</span><br></pre></td></tr></table></figure>

<p>解决办法：在PHP源码目录下 vim Makefile 找到 EXTRA_LIBS 行（带有很多参数的行），在行末添加 ‘ -llber ‘ 保存退出再次make即可。<br>解决办法：遇到这种类似的情况，说明「./configure 」沒抓好一些环境变数值。解决方法，来自老外的一篇文章：<br>在PHP源码目录下 vi Makefile 找到 EXTRA_LIBS 行，在行末添加 ‘ -llber ‘ 保存退出再次make即可</p>
<p>安装成功</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7Gome php-7.3.8]<span class="comment"># make install</span></span><br><span class="line">Installing shared extensions:     /usr/<span class="built_in">local</span>/php/lib/php/extensions/no-debug-zts-20180731/</span><br><span class="line">Installing PHP CLI binary:        /usr/<span class="built_in">local</span>/php/bin/</span><br><span class="line">Installing PHP CLI man page:      /usr/<span class="built_in">local</span>/php/php/man/man1/</span><br><span class="line">Installing PHP FPM binary:        /usr/<span class="built_in">local</span>/php/sbin/</span><br><span class="line">Installing PHP FPM defconfig:     /usr/<span class="built_in">local</span>/php/etc/</span><br><span class="line">Installing PHP FPM man page:      /usr/<span class="built_in">local</span>/php/php/man/man8/</span><br><span class="line">Installing PHP FPM status page:   /usr/<span class="built_in">local</span>/php/php/php/fpm/</span><br><span class="line">Installing phpdbg binary:         /usr/<span class="built_in">local</span>/php/bin/</span><br><span class="line">Installing phpdbg man page:       /usr/<span class="built_in">local</span>/php/php/man/man1/</span><br><span class="line">Installing PHP CGI binary:        /usr/<span class="built_in">local</span>/php/bin/</span><br><span class="line">Installing PHP CGI man page:      /usr/<span class="built_in">local</span>/php/php/man/man1/</span><br><span class="line">Installing build environment:     /usr/<span class="built_in">local</span>/php/lib/php/build/</span><br><span class="line">Installing header files:          /usr/<span class="built_in">local</span>/php/include/php/</span><br><span class="line">Installing helper programs:       /usr/<span class="built_in">local</span>/php/bin/</span><br><span class="line">  program: phpize</span><br><span class="line">  program: php-config</span><br><span class="line">Installing man pages:             /usr/<span class="built_in">local</span>/php/php/man/man1/</span><br><span class="line">  page: phpize.1</span><br><span class="line">  page: php-config.1</span><br><span class="line">/usr/<span class="built_in">local</span>/src/php-7.3.8/build/shtool install -c ext/phar/phar.phar /usr/<span class="built_in">local</span>/php/bin</span><br><span class="line">ln -s -f phar.phar /usr/<span class="built_in">local</span>/php/bin/phar</span><br><span class="line">Installing PDO headers:           /usr/<span class="built_in">local</span>/php/include/php/ext/pdo/</span><br></pre></td></tr></table></figure>

<p>配置<br>移动php配置文件的位置，并修改名<br>php-fpm.conf是 php-fpm 进程服务的配置文件<br><a href="http://www.conf是" target="_blank" rel="noopener">www.conf是</a> php-fpm 进程服务的扩展配置文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp /usr/<span class="built_in">local</span>/php/etc/php-fpm.conf.default /usr/<span class="built_in">local</span>/php/etc/php-fpm.conf</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp /usr/<span class="built_in">local</span>/php/etc/php-fpm.d/www.conf.default /usr/<span class="built_in">local</span>/php/etc/php-fpm.d/www.conf</span><br></pre></td></tr></table></figure>

<p>复制php.ini文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp /usr/<span class="built_in">local</span>/src/php-7.3.8/php.ini-production /usr/<span class="built_in">local</span>/php/etc/php.ini</span><br></pre></td></tr></table></figure>

<p>启动php-fpm</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7Gome php-7.3.8]<span class="comment"># ps -ef | grep php-fpm</span></span><br><span class="line">root      3201     1  0 17:55 ?        00:00:00 php-fpm: master process (/usr/<span class="built_in">local</span>/php/etc/php-fpm.conf)</span><br><span class="line">www       3202  3201  0 17:55 ?        00:00:00 php-fpm: pool www</span><br><span class="line">www       3203  3201  0 17:55 ?        00:00:00 php-fpm: pool www</span><br><span class="line">root      3205 12571  0 17:55 pts/0    00:00:00 grep --color=auto php-fpm</span><br></pre></td></tr></table></figure>

<p>编辑vim /usr/local/nginx/nginx.conf</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/<span class="built_in">local</span>/nginx/nginx.conf</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">        location / &#123;</span><br><span class="line">            root   html;</span><br><span class="line">            index  index.php index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        location ~ \.php$ &#123;</span><br><span class="line">            root           html;</span><br><span class="line">            fastcgi_pass   127.0.0.1:9000;</span><br><span class="line">            fastcgi_index  index.php;</span><br><span class="line">            fastcgi_param  SCRIPT_FILENAME  /scripts<span class="variable">$fastcgi_script_name</span>;</span><br><span class="line">            include        fastcgi_params;</span><br><span class="line">I			nclude fastcgi.conf;  <span class="comment">#安装的时候没有，加上去</span></span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart php-fpm <span class="comment">#重启php-fpm</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart nginx <span class="comment">#重启ngingx</span></span><br></pre></td></tr></table></figure>

<ul>
<li>搭建完成<img src="/p/2293fa6a/13.png"></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/p/977b1b01/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="阿深">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/head3.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="阿深">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/p/977b1b01/" itemprop="url">centos7下redis5编译安装</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-07-01T23:50:05+08:00">
                2019-07-01
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/服务/" itemprop="url" rel="index">
                    <span itemprop="name">服务</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/服务/部署/" itemprop="url" rel="index">
                    <span itemprop="name">部署</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="下载-redis-5-0-2"><a href="#下载-redis-5-0-2" class="headerlink" title="下载 redis 5.0.2"></a>下载 redis 5.0.2</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget -c http://download.redis.io/releases/redis-5.0.2.tar.gz</span><br></pre></td></tr></table></figure>

<h3 id="解压到目录"><a href="#解压到目录" class="headerlink" title="解压到目录"></a>解压到目录</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf redis-5.0.2.tar.gz -C /usr/<span class="built_in">local</span>/</span><br><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/redis-5.0.2/</span><br></pre></td></tr></table></figure>

<h3 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make</span><br></pre></td></tr></table></figure>

<h3 id="安装到指定位置"><a href="#安装到指定位置" class="headerlink" title="安装到指定位置"></a>安装到指定位置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make  PREFIX=/usr/<span class="built_in">local</span>/redis-5.0.2 install</span><br></pre></td></tr></table></figure>

<h3 id="编辑配置文件"><a href="#编辑配置文件" class="headerlink" title="编辑配置文件"></a>编辑配置文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/<span class="built_in">local</span>/redis-5.0.2/redis.conf</span><br></pre></td></tr></table></figure>

<p>在配置文件里面修改一下项目:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"># 修改一下配置</span><br><span class="line"># redis以守护进程的方式运行</span><br><span class="line"># no表示不以守护进程的方式运行(会占用一个终端)  </span><br><span class="line">daemonize yes</span><br><span class="line"></span><br><span class="line"># 客户端闲置多长时间后断开连接，默认为0关闭此功能                                      </span><br><span class="line">timeout 300</span><br><span class="line"></span><br><span class="line"># 设置redis日志级别，默认级别：notice                     </span><br><span class="line">loglevel verbose</span><br><span class="line"></span><br><span class="line"># 设置日志文件的输出方式,如果以守护进程的方式运行redis 默认:&quot;&quot;  如果要写入文件可以直接指定文件路径。</span><br><span class="line"># 并且日志输出设置为stdout,那么日志信息就输出到/dev/null里面去了 </span><br><span class="line">logfile stdout</span><br><span class="line"># 设置密码授权</span><br><span class="line">requirepass &lt;设置密码&gt;</span><br><span class="line"># 监听ip</span><br><span class="line">bind 127.0.0.1 </span><br><span class="line">#指定监听端口 默认为6379</span><br><span class="line">port 6379</span><br><span class="line">#持久化数据存放目录 默认为./表示当前目录</span><br><span class="line">dir /data/redis</span><br><span class="line">#RBD持久化数据文件 保持默认</span><br><span class="line">dbfilename dump.rdb</span><br></pre></td></tr></table></figure>

<h3 id="添加系统服务与开机启动"><a href="#添加系统服务与开机启动" class="headerlink" title="添加系统服务与开机启动:"></a>添加系统服务与开机启动:</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/lib/systemd/system/redis.service</span><br></pre></td></tr></table></figure>

<p>内容如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=Redis</span><br><span class="line">After=syslog.target network.target remote-fs.target nss-lookup.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=forking</span><br><span class="line">PIDFile=/var/run/redis_6379.pid</span><br><span class="line">ExecStart=/usr/local/redis-5.0.2/bin/redis-server /usr/local/redis-5.0.2/redis.conf</span><br><span class="line">ExecReload=/bin/kill -s HUP $MAINPID </span><br><span class="line">ExecStop=/bin/kill -s QUIT $MAINPID </span><br><span class="line">PrivateTmp=true</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>

<p>保存退出</p>
<p>添加环境变量:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/profile</span><br></pre></td></tr></table></figure>

<p>添加内容如下:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:/usr/<span class="built_in">local</span>/redis-5.0.2/bin</span><br></pre></td></tr></table></figure>

<p>使环境变量生效:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> /etc/profile</span><br></pre></td></tr></table></figure>

<p>重载服务配置:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br></pre></td></tr></table></figure>

<p>启动redis:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start redis</span><br></pre></td></tr></table></figure>

<p>添加开机启动:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">enable</span> redis</span><br></pre></td></tr></table></figure>

<p>第六步测试redis数据库<br>链接redis数据库:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli</span><br></pre></td></tr></table></figure>

<p>验证密码:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AUTH &lt;password&gt;</span><br></pre></td></tr></table></figure>

<p><password>为你自己设置的密码<br>写入数据:</password></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> name 888</span><br></pre></td></tr></table></figure>

<p>查看数据:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">get name</span><br><span class="line">``` </span><br><span class="line">删除数据:</span><br><span class="line">```bash</span><br><span class="line">DEL name</span><br></pre></td></tr></table></figure>

<h3 id="安装PHP扩展"><a href="#安装PHP扩展" class="headerlink" title="安装PHP扩展"></a>安装PHP扩展</h3><blockquote>
<p>下载扩展包</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget -c https://pecl.php.net/get/redis-5.0.2.tgz</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">tar xzf redis-5.0.2.tgz <span class="comment"># 解压</span></span><br><span class="line">``` </span><br><span class="line"><span class="comment">### 进入文件夹并编译php扩展</span></span><br><span class="line">```bash</span><br><span class="line"><span class="built_in">cd</span> redis-5.0.2/</span><br><span class="line">phpize</span><br></pre></td></tr></table></figure>

<h3 id="配置环境"><a href="#配置环境" class="headerlink" title="配置环境"></a>配置环境</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./configure --with-php-config=/usr/<span class="built_in">local</span>/php/bin/php-config</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这里的php-config路径 根据自己实际情况而定</p>
</blockquote>
<h3 id="编译安装"><a href="#编译安装" class="headerlink" title="编译安装"></a>编译安装</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#出现#Installing shared extensions:/usr/local/php/lib/php/extensions/no-debug-non-zts-20131226/#即为安装成功。</span><br><span class="line">#打开php.in文件，并添加 extension=redis.so,</span><br><span class="line">保存退出即可</span><br><span class="line">vim /usr/local/php/etc/php.ini </span><br><span class="line">#文件末尾添加 extension=redis.so  #保存退出，</span><br></pre></td></tr></table></figure>

<p>重启php-fpm</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart php-fpm</span><br></pre></td></tr></table></figure>

<h3 id="安装完成，查看phpInfo-："><a href="#安装完成，查看phpInfo-：" class="headerlink" title="安装完成，查看phpInfo()："></a>安装完成，查看phpInfo()：</h3><img src="/p/977b1b01/1.png">

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/p/f459561d/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="阿深">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/head3.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="阿深">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/p/f459561d/" itemprop="url">时间操作</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-01-07T16:06:06+08:00">
                2019-01-07
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/后端/" itemprop="url" rel="index">
                    <span itemprop="name">后端</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/后端/PHP/" itemprop="url" rel="index">
                    <span itemprop="name">PHP</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h5 id="1-列出日期范围内的所有日期"><a href="#1-列出日期范围内的所有日期" class="headerlink" title="1. 列出日期范围内的所有日期"></a>1. 列出日期范围内的所有日期</h5><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">date_range</span><span class="params">($first, $last, $step = <span class="string">'+1 day'</span>, $format = <span class="string">'Y-m-d'</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    $dates = <span class="keyword">array</span>();</span><br><span class="line">    $current = strtotime($first);</span><br><span class="line">    $last = strtotime($last);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> ($current &lt;= $last) &#123;</span><br><span class="line"></span><br><span class="line">        $dates[] = date($format, $current);</span><br><span class="line"></span><br><span class="line">        $current = strtotime($step, $current);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $dates;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// test: print_r(date_range('2014-06-22', '2014-07-02'));</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//PHP &gt; 5.3 ，用此版本</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">date_range2</span><span class="params">($first, $last)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    $period = <span class="keyword">new</span> DatePeriod(</span><br><span class="line">        <span class="keyword">new</span> DateTime($first),</span><br><span class="line">        <span class="keyword">new</span> DateInterval(<span class="string">'P1D'</span>),</span><br><span class="line">        <span class="keyword">new</span> DateTime($last)</span><br><span class="line">    );</span><br><span class="line">    $dates = [];</span><br><span class="line">    <span class="keyword">foreach</span> ($period <span class="keyword">as</span> $date) &#123;</span><br><span class="line"></span><br><span class="line">        $dates[] = $date-&gt;format(<span class="string">'Y-m-d'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $dates;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// test: print_r(date_range('2014-06-22', '2014-07-02'));</span></span><br></pre></td></tr></table></figure>

<h5 id="2-获取自定义时间范围"><a href="#2-获取自定义时间范围" class="headerlink" title="2. 获取自定义时间范围"></a>2. 获取自定义时间范围</h5><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取自定义时间范围</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> $type 1:每天 2:每周 3:每月 4:每季 5:每年 6：上季度</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> array</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_diy_date</span><span class="params">($type)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> ($type) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">            <span class="comment">//每天</span></span><br><span class="line">            $start = mktime(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, date(<span class="string">'m'</span>), date(<span class="string">'d'</span>), date(<span class="string">'Y'</span>));</span><br><span class="line">            $end = mktime(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, date(<span class="string">'m'</span>), date(<span class="string">'d'</span>) + <span class="number">1</span>, date(<span class="string">'Y'</span>)) - <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">            <span class="comment">//每周</span></span><br><span class="line">            $start = mktime(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, date(<span class="string">'m'</span>), date(<span class="string">'d'</span>) - date(<span class="string">'w'</span>) + <span class="number">1</span> - <span class="number">7</span>, date(<span class="string">'Y'</span>));</span><br><span class="line">            $end = mktime(<span class="number">23</span>, <span class="number">59</span>, <span class="number">59</span>, date(<span class="string">'m'</span>), date(<span class="string">'d'</span>) - date(<span class="string">'w'</span>) + <span class="number">7</span> - <span class="number">7</span>, date(<span class="string">'Y'</span>));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">            <span class="comment">//3:每月</span></span><br><span class="line">            $start = mktime(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, date(<span class="string">'m'</span>), <span class="number">1</span>, date(<span class="string">'Y'</span>));</span><br><span class="line">            $end = mktime(<span class="number">23</span>, <span class="number">59</span>, <span class="number">59</span>, date(<span class="string">'m'</span>), date(<span class="string">'t'</span>), date(<span class="string">'Y'</span>));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">            <span class="comment">//本季度</span></span><br><span class="line">            $season = ceil((date(<span class="string">'n'</span>)) / <span class="number">3</span>);<span class="comment">//当月是第几季度</span></span><br><span class="line">            $start = mktime(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, $season * <span class="number">3</span> - <span class="number">3</span> + <span class="number">1</span>, <span class="number">1</span>, date(<span class="string">'Y'</span>));</span><br><span class="line">            $end = mktime(<span class="number">23</span>, <span class="number">59</span>, <span class="number">59</span>, $season * <span class="number">3</span>, date(<span class="string">'t'</span>, mktime(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, $season * <span class="number">3</span>, <span class="number">1</span>, date(<span class="string">"Y"</span>))), date(<span class="string">'Y'</span>));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">            <span class="comment">//每年</span></span><br><span class="line">            $start = mktime(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, date(<span class="string">"Y"</span>, time()));<span class="comment">//今年开始</span></span><br><span class="line">            $end = mktime(<span class="number">23</span>, <span class="number">59</span>, <span class="number">59</span>, <span class="number">12</span>, <span class="number">31</span>, date(<span class="string">"Y"</span>, time()));<span class="comment">//今年结束</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line">            <span class="comment">//上季度</span></span><br><span class="line">            $season = ceil((date(<span class="string">'n'</span>)) / <span class="number">3</span>) - <span class="number">1</span>;<span class="comment">//上季度是第几季度</span></span><br><span class="line">            $start = mktime(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, $season * <span class="number">3</span> - <span class="number">3</span> + <span class="number">1</span>, <span class="number">1</span>, date(<span class="string">'Y'</span>));</span><br><span class="line">            $end = mktime(<span class="number">23</span>, <span class="number">59</span>, <span class="number">59</span>, $season * <span class="number">3</span>, date(<span class="string">'t'</span>, mktime(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, $season * <span class="number">3</span>, <span class="number">1</span>, date(<span class="string">"Y"</span>))), date(<span class="string">'Y'</span>));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            $start = mktime(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, date(<span class="string">'m'</span>), date(<span class="string">'d'</span>), date(<span class="string">'Y'</span>));</span><br><span class="line">            $end = mktime(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, date(<span class="string">'m'</span>), date(<span class="string">'d'</span>) + <span class="number">1</span>, date(<span class="string">'Y'</span>)) - <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> [date(<span class="string">'Y-m-d H:i:s'</span>, $start), date(<span class="string">'Y-m-d H:i:s'</span>, $end)];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/p/93441cba/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="阿深">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/head3.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="阿深">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/p/93441cba/" itemprop="url">Docker环境下jenkins结合gitlab自动化部署</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-11-16T11:55:56+08:00">
                2018-11-16
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/服务/" itemprop="url" rel="index">
                    <span itemprop="name">服务</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/服务/部署/" itemprop="url" rel="index">
                    <span itemprop="name">部署</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Windows下使用docker-toolbox-或-win10使用Dockerinstaller-安装docekr"><a href="#Windows下使用docker-toolbox-或-win10使用Dockerinstaller-安装docekr" class="headerlink" title="Windows下使用docker toolbox 或 win10使用Dockerinstaller 安装docekr"></a>Windows下使用docker toolbox 或 win10使用Dockerinstaller 安装docekr</h1><ul>
<li>安装 jenkins<br>docker run -p 8010:8080 -p 50000:50000 –name jenkins –volume /volume/jenkins:/var/jenkins_home jenkins/jenkins:lts</li>
</ul>
<p>WIN10<br>docker run -p 8010:8080 -p 50000:50000 –name jenkins –volume f:/vol/jenkins:/var/jenkins_home jenkins/jenkins:lts</p>
<p>在浏览器端访问<a href="http://192.168.99.1:8010，看到如下界面就说明启动成功" target="_blank" rel="noopener">http://192.168.99.1:8010，看到如下界面就说明启动成功</a></p>
<img src="/p/93441cba/j1.png">

<p>查看输入密码，登录进入，会看到如下页面</p>
<img src="/p/93441cba/j2.png">

<p>选择安装推荐插件即可，等待安装完成</p>
<img src="/p/93441cba/j3.png">

<p>填写要创建的管理用户这里使用Admin 密码为12345678，点击保存并完成即可</p>
<img src="/p/93441cba/j3.png">
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/p/83dcefb7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="阿深">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/head3.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="阿深">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/p/83dcefb7/" itemprop="url">PHP混淆加密解密</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-22T16:06:36+08:00">
                2018-05-22
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/后端/" itemprop="url" rel="index">
                    <span itemprop="name">后端</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/后端/PHP/" itemprop="url" rel="index">
                    <span itemprop="name">PHP</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>php混淆加密解密</p>
<p>php做为一门当下非常流行的web语言，常常看到有人求解密php文件，想当年的asp也是一样。一些人不理解为什么要混淆(加密)，甚至鄙视混淆(加密)，在我看来混淆加密代码可以用来防一般的小人，会起到一定的保护作用。</p>
<p>加密的原因：</p>
<blockquote>
<ol>
<li>保护代码，防止别人剽窃</li>
</ol>
</blockquote>
<blockquote>
<ol start="2">
<li>保护文件，防止别人发现/查杀(php木马 or 后门)</li>
</ol>
</blockquote>
<blockquote>
<ol start="3">
<li>剽窃了他人代码防止被发现</li>
</ol>
</blockquote>
<blockquote>
<ol start="4">
<li>其他商业或非商业目的</li>
</ol>
</blockquote>
<p>第一种加密方式，就是简单的使用函数encode代码之后，再eval(decode(‘encode的代码’)),解密非常简单，直接把eval替换成exit即可输出源代码，如果经过多层加密，就继续替换下去…</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">eval</span>(base64_decode(<span class="string">'PD9waHAgZWNobyAndHh0Y21zLmNvbSc7Pz4='</span>));</span><br></pre></td></tr></table></figure>

<p>解密难度：★☆☆☆☆</p>
<p>第二种威盾加密，做为第一种方式的升级版，即把之前的base64之类的系统内置函数变成了匿名函数。解密也是一样把eval替换成exit即可。</p>
<pre><code class="php">$OOO0O0O00=<span class="keyword">__FILE__</span>;$OOO000000=urldecode(<span class="string">'%74%68%36%73%62%65%68%71%6c%61%34%63%6f%5f%73%61%64%66%70%6e%72'</span>);$OO00O0000=<span class="number">28</span>;$OOO0000O0=$OOO000000{<span class="number">4</span>}.$OOO000000{<span class="number">9</span>}.$OOO000000{<span class="number">3</span>}.$OOO000000{<span class="number">5</span>};$OOO0000O0.=$OOO000000{<span class="number">2</span>}.$OOO000000{<span class="number">10</span>}.$OOO000000{<span class="number">13</span>}.$OOO000000{<span class="number">16</span>};$OOO0000O0.=$OOO0000O0{<span class="number">3</span>}.$OOO000000{<span class="number">11</span>}.$OOO000000{<span class="number">12</span>}.$OOO0000O0{<span class="number">7</span>}.$OOO000000{<span class="number">5</span>};$O0O0000O0=<span class="string">'OOO0000O0'</span>;<span class="keyword">eval</span>(($$O0O0000O0(<span class="string">'JE9PME9PMDAwMD.//......省略</span>
<span class="string"></span></code></pre>
<p>解密难度：★★☆☆☆</p>
<p>第三种Zend Guard,这种加密方式无法像前面一样手动解密。需要用到工具，如：dezender黑刀。 目前我知道的就只有php4~php5.2的可以被此工具解密出来，解密出来的变量或函数可能比较丑像$_obfuscate开头，因为经过混淆了。不过如果在php代码里加上一句代码，可使该程序溢出导致解密失败。</p>
<p>@Zend; 3074; 以下省略乱码<br>解密难度：★★★★☆</p>
<p>第四种二进制(unicode乱码)加密，如phpjm,phpdp神盾。这种加密方式其实也是威盾的升级版，即把匿名函数字符串经过一系列的打乱分散处理之后，再把函数、变量、字符串替换成经过处理的unicode字符串。这样生成的文件就不能轻易的修改了。加大了解密的难度，解密方法也简单，就是替换掉那些变量和方法，使之成为正常的字符串，再exit即可。</p>
<pre><code class="php"><span class="keyword">if</span> (!defined(<span class="string">"BEEABDD"</span>)){define(<span class="string">"BEEABDD"</span>, <span class="keyword">__FILE__</span>);<span class="keyword">global</span> $?$妰,$唽,$墎儢,$唫敊?$槀垙梽,$厠墪儛?$嚌巵嚀亸,$寬剛檲槗,$拹枩崄厷?$湠湜啔増仦?$憻檮劀瀺晵€?$垵啑崙媺悎剹,$倧€剮寳崊湌倹€,$槏偀梹啅€攢専挄,$剦槙姙儣枓瀿厐巼;<span class="function"><span class="keyword">function</span> 殸<span class="params">($殸,$妰?<span class="string">""</span>)</span></span>{.......</code></pre>
<p>解密难度：★★★★☆</p>
<p>总结：<br>1；php无扩展加密无非用到的几个函数 eval , preg_replace使用e修饰符 , strtr , base64_decode。<br>2；收费的放弃；<br>3；需要安装额外扩展的，例如bcompiler，放弃；<br>4；混淆只会为程序添加另一层潜在的错误和安全漏洞（PS）；<br>5；目的为了防小人，所以做简单的代码混淆；</p>
<hr>
<p>测试了多个开源库，以下这个较为理想；<br>混淆过程：</p>
<img src="/p/83dcefb7/jiami1.png" title="混淆过程">

<p>混淆结果：</p>
<img src="/p/83dcefb7/jiami2.png" title="混淆结果1">
<img src="/p/83dcefb7/jiami3.png" title="混淆结果2">

<p> a；文件多行代码会合并为少量几行代码；<br>  b；类的共有方法不会修改；只混淆私有方法，常量不会混淆；方法或函数的参数混淆；<br>  c；混淆 后代码运行正常；</p>
<p>理论上可行；这是研究的结果；</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/p/1d9fbb6a/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="阿深">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/head3.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="阿深">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/p/1d9fbb6a/" itemprop="url">Docker基础</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-02-15T22:23:17+08:00">
                2018-02-15
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/服务/" itemprop="url" rel="index">
                    <span itemprop="name">服务</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/服务/docker/" itemprop="url" rel="index">
                    <span itemprop="name">docker</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Docker 包括三个基本概念 <strong>镜像（ Image ）</strong> <strong>容器（ Container ）</strong> <strong>仓库（ Repository ）</strong></p>
<hr>
<p>使用 Docker 镜像<br>从 Docker 镜像仓库获取镜像的命令是 docker pull，其命令格式为：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull [选项] [Docker Registry 地址[:端口号]/]仓库名[:标签]</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull ubuntu:16.04</span><br></pre></td></tr></table></figure>

<p>且进行交互式操作</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -it --rm ubuntu:16.04 bash</span><br></pre></td></tr></table></figure>

<hr>
<p>Dockerfile</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">FROM nginx</span><br><span class="line">RUN <span class="built_in">test</span>=<span class="string">'ls -a'</span> \</span><br><span class="line">    &amp;&amp; <span class="built_in">echo</span> <span class="string">'&lt;h1&gt;Hello, Docker!&lt;h1&gt;'</span> &gt; /usr/share/nginx/html/index.html \</span><br><span class="line">    &amp;&amp; mkdir /usr/share/nginx/html/<span class="built_in">test</span> \</span><br><span class="line">    &amp;&amp; <span class="built_in">cd</span> /usr/share/nginx/html/<span class="built_in">test</span> \</span><br><span class="line">    &amp;&amp; touch index.php \</span><br><span class="line">    &amp;&amp; <span class="built_in">echo</span> <span class="string">'&lt;?php echo "Hello Wolrd!"; ?&gt;'</span> &gt; index.php <span class="variable">$test</span></span><br></pre></td></tr></table></figure>

<p>然后在 Dockerfile 文件所在目录执行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -t nginx:v3 .</span><br></pre></td></tr></table></figure>

<p>就可以构建一个镜像啦</p>
<hr>
<p>镜像构建上下文（Context）</p>
<p>我是这么理解的：</p>
<img src="/p/1d9fbb6a/1.png" title="上下文">
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">FROM nginx</span><br><span class="line">COPY ./123t /usr/share/nginx/html/tttttttttt</span><br><span class="line">RUN <span class="built_in">test</span>=<span class="string">'ls -a'</span> \</span><br><span class="line">    &amp;&amp; <span class="built_in">echo</span> <span class="string">'&lt;h1&gt;Hello, Docker!&lt;h1&gt;'</span> &gt; /usr/share/nginx/html/index.html \</span><br><span class="line">    &amp;&amp; mkdir /usr/share/nginx/html/<span class="built_in">test</span> \</span><br><span class="line">    &amp;&amp; <span class="built_in">cd</span> /usr/share/nginx/html/<span class="built_in">test</span> \</span><br><span class="line">    &amp;&amp; touch index.php \</span><br><span class="line">    &amp;&amp; <span class="built_in">echo</span> <span class="string">'&lt;?php echo "Hello Wolrd!"; ?&gt;'</span> &gt; index.php \</span><br><span class="line">    &amp;&amp; <span class="built_in">cd</span> /usr/share/nginx/html <span class="variable">$test</span></span><br></pre></td></tr></table></figure>

<p>buidl时，会吧123t复制到 当前上下文，但是没有到镜像中，执行COPY命令后，就把123t复制到镜像啦</p>
<hr>
<p>ENTRYPOINT 入口点</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">FROM ubuntu:16.04</span><br><span class="line">RUN apt-get update \</span><br><span class="line">    &amp;&amp; apt-get install -y curl \</span><br><span class="line">    &amp;&amp; rm -rf /var/lib/apt/lists/*</span><br><span class="line">ENTRYPOINT [<span class="string">"curl"</span>, <span class="string">"-s"</span>, <span class="string">"http://ip.cn"</span>]</span><br></pre></td></tr></table></figure>

<hr>
<p>VOLUME 定义匿名卷<br>容器运行时应该尽量保持容器存储层不发生写操作，对于数据库类需要保存 动态数据的应用，其数据库文件应该保存于卷(volume)中</p>
<hr>
<p>EXPOSE 声明端口</p>
<p>EXPOSE 指令是声明运行时容器提供服务端口，这只是一个声明，在运行时并不会因为这个声 明应用就会开启这个端口的服务。在 Dockerfile 中写入这样的声明有两个好处，一个是帮助 镜像使用者理解这个镜像服务的守护端口，以方便配置映射；另一个用处则是在运行时使用 随机端口映射时，也就是 docker run -P 时，会自动随机映射 EXPOSE 的端口。</p>
<hr>
<p>WORKDIR 指定工作目录<br>格式为 WORKDIR &lt;工作目录路径&gt; 。 使用 WORKDIR 指令可以来指定工作目录（或者称为当前目录），以后各层的当前目录就被改 为指定的目录，如该目录不存在， WORKDIR 会帮你建立目录</p>
<hr>
<p>USER 指定当前用户<br>格式： USER &lt;用户名&gt; USER 指令和 WORKDIR 相似，都是改变环境状态并影响以后的层。 WORKDIR 是改变工作目 录， USER 则是改变之后层的执行 RUN , CMD 以及 ENTRYPOINT 这类命令的身份。</p>
<hr>
<p>操作 Docker 容器<br>简单的说，容器是独立运行的一个或一组应用，以及它们的运行态环境。对应的，虚拟机可 以理解为模拟运行的一整套操作系统（提供了运行态环境和其他系统环境）和跑在上面的应 用。</p>
<hr>
<p>启动容器<br>启动容器有两种方式，一种是基于镜像新建一个容器并启动，另外一个是将在终止状态 （ stopped ）的容器重新启动。 因为 Docker 的容器实在太轻量级了，很多时候用户都是随时删除和新创建容器。<br> 新建并启动 所需要的命令主要为 docker run 。<br>$ docker run -t -i ubuntu:14.04 /bin/bash root@af8bae53bdd3:/# 其中， -t 选项让Docker分配一个伪终端（pseudo-tty）并绑定到容器的标准输入上， -i 则让容器的标准输入保持打开。</p>
<hr>
<p>当利用 docker run 来创建容器时，Docker 在后台运行的标准操作包括：<br>检查本地是否存在指定的镜像，不存在就从公有仓库下载 利用镜像创建并启动一个容器 分配一个文件系统，并在只读的镜像层外面挂载一层可读写层 从宿主主机配置的网桥接口中桥接一个虚拟接口到容器中去 从地址池配置一个 ip 地址给容器 执行用户指定的应用程序 执行完毕后容器被终止</p>
<hr>
<p>导出和导入容器<br>导出容器 如果要导出本地某个容器，可以使用 docker export 命令</p>
<hr>
<p>清理所有处于终止状态的容器 用 docker container ls -a 命令可以查看所有已经创建的包括终止状态的容器，如果数量太 多要一个个删除可能会很麻烦，用下面的命令可以清理掉所有处于终止状态的容器。 $ docker container prune</p>
<hr>
<p>访问仓库<br>根据是否是官方提供，可将镜像资源分为两类。 一种是类似 centos 这样的镜像，被称为基础镜像或根镜像。这些基础镜像由 Docker 公司创 建、验证、支持、提供。这样的镜像往往使用单个单词作为名字。 还有一种类型，比如 tianon/centos 镜像，它是由 Docker 的用户创建并维护的，往往带有 用户名称前缀。可以通过前缀 username/ 来指定使用某个用户提供的镜像，比如 tianon 用 户。</p>
<hr>
<p>推送镜像<br>用户也可以在登录后通过 docker push 命令来将自己的镜像推送到 Docker Hub。</p>
<hr>
<p>私有仓库 </p>
<p>安装运行 docker-registry 容器运行 你可以通过获取官方 registry 镜像来运行。<br> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 5000:5000 --restart=always --name registry registry</span><br></pre></td></tr></table></figure></p>
<p> 这将使用官方的 registry 镜像来启动私有仓库。默认情况下，仓库会被创建在容器的 /var/lib/registry 目录下。你可以通过 -v 参<br> 数来将镜像文件存放在本地的指定路径。例 如下面的 例子将上传的镜像放到本地的 /opt/data/registry 目录:<br> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d \ -p 5000:5000 \ -v /opt/data/registry:/var/lib/registry \ registry</span><br></pre></td></tr></table></figure></p>
<p> 在私有仓库上传、搜索、下载镜像 创建好私有仓库之后，就可以使用 docker tag 来标记一个镜像，然后推送它到仓库。例如 私有仓库地址为 127.0.0.1:5000</p>
<p><a href="http://192.168.99.100:5000/" target="_blank" rel="noopener">http://192.168.99.100:5000/</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker tag myip:latest 192.168.99.100:5000/myip:latest</span><br></pre></td></tr></table></figure>

<hr>
<p>数据卷：<br><strong>数据卷</strong>是一个可供一个或多个容器使用的特殊目录，它绕过 UFS，可以提供很多有用的特性： 数据卷可以在容器之间共享和重用对<br>数据卷 的修改会立马生效 对 数据卷 的更新，不会影响镜像 数据卷 默认会一直存在，即使容器被删除，注意： 数据卷 的使用，类似<br>于 Linux 下对目录或文件进行 mount，镜像中的被指定为挂 载点的目录中的文件会隐藏掉，能显示看的是挂载的 数据卷 。 选择 -v<br>还是 <strong>–mount</strong> 参数 Docker 新用户应该选择 <strong>–mount</strong> 参数，经验丰富的 Docker 使用者对 -v 或者 <strong>–volume</strong> 已经很熟悉了，但是推<br>荐使用 <strong>–mount</strong> 参数。 </p>
<blockquote>
<p>创建一个数据卷</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker volume create my-vol</span><br></pre></td></tr></table></figure>

<blockquote>
<p>查看所有的 数据卷</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker volume ls <span class="built_in">local</span> my-vol</span><br><span class="line">``` </span><br><span class="line">&gt;在主机里使用以下命令可以查看指 数据卷的信息</span><br><span class="line">```bash</span><br><span class="line"> docker volume inspect my-vol</span><br></pre></td></tr></table></figure>

<hr>
<p>容器互联：<br>新建网络 ：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker network create -d bridge my-net</span><br></pre></td></tr></table></figure>

<hr>
<p>Compose</p>
<p>使用 术语 首先介绍几个术语。 服务 ( service )：一个应用容器，实际上可以运行多个相同镜像的实例。 项目 ( project )：由一组<br>关联的应用容器组成的一个完整业务单元。 可见，一个项目可以由多个服务（容器）关联而成， Compose 面向项目进行管理。<br>场景最常见的项目是 web 网站，该项目应该包含 web 应用和缓存。 下面我们用 Python 来建立一个能够记录页面访问次数的 web 网站</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/p/d1504f96/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="阿深">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/head3.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="阿深">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/p/d1504f96/" itemprop="url">SolrCloud5.5部署和使用</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-11-15T01:32:06+08:00">
                2017-11-15
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PHP/" itemprop="url" rel="index">
                    <span itemprop="name">PHP</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PHP/全文检索/" itemprop="url" rel="index">
                    <span itemprop="name">全文检索</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="SolrCloud5-5-部署"><a href="#SolrCloud5-5-部署" class="headerlink" title="SolrCloud5.5 部署"></a>SolrCloud5.5 部署</h1><p>#1.SolrCloud基本概念</p>
<p>摘自：<a href="http://www.it165.net/pro/html/201506/45483.html" target="_blank" rel="noopener">http://www.it165.net/pro/html/201506/45483.html</a></p>
<h2 id="1-1-SolrCloud相关概念"><a href="#1-1-SolrCloud相关概念" class="headerlink" title="1.1  SolrCloud相关概念"></a>1.1  SolrCloud相关概念</h2><p> SolrCloud中有四个关键名词： <strong>core</strong> 、 <strong>collection</strong> 、 <strong>shard</strong> 、 <strong>node</strong> 。</p>
<p><strong>core</strong> ：在Solr单机环境中，core本质上就是单个index。若需有多个index，那必须创建多个core。在SolrCloud环境中，单个index可以横跨多个Solr实例，这意味着单个index是由不同机器上的多个cores组成。</p>
<p><strong>collection</strong> ：由core组成的逻辑index叫做 <strong>collection</strong> ，一个collection是跨越多个cores的index，这使index可扩展并冗余备份。</p>
<p><strong>shard</strong> ：在SolrCloud中可以有多个collections。Collections可被分片，每个分片可有多个副本（Replica），同一副本下的相同分片称为 <strong>shards</strong> 。每个shards下的有一个分片为leader，该leader通过选举策略产生。</p>
<p><strong>node</strong> ：SolrCloud中，node是运行Solr的Java虚拟机实例，也就是Server（例如Tomcat、Jetty）。</p>
<p>理解core和collection的区别非常重要。在传统的单node solr中，core和collection的概念等同，都代表一个逻辑index。在SolrCloud中，多个nodes下的cores形成一个collection。</p>
<h2 id="1-2-SolrCloud路由"><a href="#1-2-SolrCloud路由" class="headerlink" title="1.2 SolrCloud路由"></a>1.2 SolrCloud路由</h2><p>SolrCloud中，提供了两种路由算法：</p>
<p><strong>compositeIdimplicit</strong>  在创建Collection时，需要通过router.name指定路由策略，默认为compositeId路由。</p>
<h4 id="compositeId"><a href="#compositeId" class="headerlink" title="compositeId"></a><strong>compositeId</strong></h4><p>该路由为一致性哈希路由，shards的哈希范围从80000000~7fffffff。初始创建collection是必须指定numShards，compositeId路由算法根据numShards的个数，计算出每个shard的哈希范围，因此路由策略不可以扩展shard。</p>
<h4 id="implicit"><a href="#implicit" class="headerlink" title="implicit"></a><strong>implicit</strong></h4><p>该路由方式指定索引具体落在路由到哪个Shard，这与compositeId路由方式索引可均匀分布在每个shard上不同。同时 <strong>只有在implicit路由策略下才可</strong></p>
<p>1.</p>
<h1 id="2-Solr5-x和以前版本的区别"><a href="#2-Solr5-x和以前版本的区别" class="headerlink" title="2.Solr5.x和以前版本的区别"></a>2.Solr5.x和以前版本的区别</h1><p>摘自：<a href="http://www.tuicool.com/articles/aiYRJjv" target="_blank" rel="noopener">http://www.tuicool.com/articles/aiYRJjv</a></p>
<p>solr5发布有一段时间了，5系列跟4的最大区别是5被发布成一个独立的应用，而不再需要Tomcat等容器，在其内部集成了一个jetty容器，现在它可以通过bin目录的脚本直接启动。</p>
<p>solr5的应用方式有两种：独立模式（Standalone）和云模式（SolrCloud）。</p>
<p>solr5的启动方式有两种，相应地其对索引的管理也有两种方式，在独立模式以是以core来管理，在云模式下是collection来管理。</p>
<p>1.</p>
<h1 id="3-部署流程【失败了】"><a href="#3-部署流程【失败了】" class="headerlink" title="3.部署流程【失败了】"></a>3.部署流程【失败了】</h1><ol>
<li>3.1启动ZK集群</li>
</ol>
<h2 id="3-2-启动Solr"><a href="#3-2-启动Solr" class="headerlink" title="3.2 启动Solr"></a>3.2 启动Solr</h2><p>摘自：<a href="http://wenku.baidu.com/link?url=wRfVyDLuS15uoAruz9-HDgQ3w5MqJMCD52AYKaPWdNDHg_WJ_ciboXyfsedn6SrqERuy_dg4gstFYR8vj07dd_TkS6ais03Dsmqq-6_M8NW" target="_blank" rel="noopener">http://wenku.baidu.com/link?url=wRfVyDLuS15uoAruz9-HDgQ3w5MqJMCD52AYKaPWdNDHg_WJ_ciboXyfsedn6SrqERuy_dg4gstFYR8vj07dd_TkS6ais03Dsmqq-6_M8NW</a></p>
<p>执行命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 solr]<span class="comment"># ./bin/solr start -c -z node1:2181,node2:2181,node3:2181</span></span><br><span class="line"></span><br><span class="line">[root@node2 solr]<span class="comment"># ./bin/solr start -c -z node1:2181,node2:2181,node3:2181</span></span><br><span class="line"></span><br><span class="line">[root@node1 solr]<span class="comment"># ./bin/solr start -c -z node1:2181,node2:2181,node3:2181</span></span><br></pre></td></tr></table></figure>

<h2 id="3-3-创建Collection"><a href="#3-3-创建Collection" class="headerlink" title="3.3 创建Collection"></a>3.3 创建Collection</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 solr]<span class="comment"># ./bin/solr create\_collection -c example -d example/example-DIH/solr/solr/conf/ -shards 3 -replicationFactor 2</span></span><br></pre></td></tr></table></figure>

<p>如果出现如下错误：</p>
<img src="/p/d1504f96/1.png" title="错误">

<p>请参考：</p>
<p><a href="https://cwiki.apache.org/confluence/display/solr/Using+ZooKeeper+to+Manage+Configuration+Files" target="_blank" rel="noopener">https://cwiki.apache.org/confluence/display/solr/Using+ZooKeeper+to+Manage+Configuration+Files</a>，</p>
<p>在node1执行如下命令：为gettingstarted提交缺失的配置文件。</p>
<table>
<thead>
<tr>
<th>./server/scripts/cloud-scripts/zkcli.sh -cmd upconfig -confdir ./server/solr/configsets/data_driven_schema_configs/conf -confname myconf -z node1:2181,node2:2181,node3:2181./server/scripts/cloud-scripts/zkcli.sh -cmd linkconfig -collection gettingstarted -confname myconf -z node1:2181,node2:2181,node3:2181</th>
</tr>
</thead>
</table>
<p>再次创建collection</p>
<img src="/p/d1504f96/2.png" title="再次创建collection">
<p>命令参数说明：</p>
<table>
<thead>
<tr>
<th>-c : collection名称-d : 配置文件的路径，可以使用上面提供的实例配置-n : 配置名称可以和collection名称不同，默认这个参数不填的话，会使用collection名称作为config名称-shards : 创建的shard个数，建议和集群节点数量一致。-replicationFactor : 每个shard的副本数，综合考虑为了保证集群的稳定性，建议配置为 最少2个，最多集群节点数量/shard数量 * 2</th>
</tr>
</thead>
</table>
<h2 id="3-4-使用含DIH配置的Collection"><a href="#3-4-使用含DIH配置的Collection" class="headerlink" title="3.4 使用含DIH配置的Collection"></a>3.4 使用含DIH配置的Collection</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@node3 solr]<span class="comment"># ./bin/solr create\_collection -c example3 -d ./server/solr/configsets/fj\_collection/conf2/ -shards 3 -replicationFactor 2</span></span><br></pre></td></tr></table></figure>

<p>启动ｃｌｏｕｄ样例后创建collection</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@node3 solr]<span class="comment"># ./bin/solr create\_collection -c example -d ./server/solr/configsets/fj\_collection/conf/ -shards 2 -replicationFactor 2</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bin/solr create\_collection -c example -d ./server/solr/configsets/fj\_collection/conf/ -shards 2 -replicationFactor 2</span><br></pre></td></tr></table></figure>

<p>错误：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">| ERROR: Failed to create collection &amp;<span class="comment">#39;example&amp;#39; due to: org.apache.solr.client.solrj.impl.HttpSolrClient$RemoteSolrException:Error from server at http://192.168.232.129:7574/solr: Error CREATEing SolrCore &amp;#39;example\_shard2\_replica1&amp;#39;: Unable to create core [example\_shard2\_replica1] Caused by: Can&amp;#39;t find resource &amp;#39;lang/stopwords\_ar.txt&amp;#39; in classpath or &amp;#39;/configs/example&amp;#39;, cwd=/usr/local/src/solr-5.5.0/server |</span></span><br><span class="line">| --- |</span><br></pre></td></tr></table></figure>

<h2 id="3-5-验证"><a href="#3-5-验证" class="headerlink" title="3.5 验证"></a>3.5 验证</h2><p>查看collection创建结果如下：</p>
<img src="/p/d1504f96/3.png" title="错误">

<p>查看zookeeper中新增记录的example的状态：</p>
<img src="/p/d1504f96/4.png" title="错误">
<p>在三个节点中都新增了配置文件</p>
<img src="/p/d1504f96/5.png" title="配置1">
<img src="/p/d1504f96/6.png" title="配置2">
<img src="/p/d1504f96/7.png" title="配置3">

<p>1.</p>
<h1 id="4-使用方法"><a href="#4-使用方法" class="headerlink" title="4. 使用方法"></a>4. 使用方法</h1><h2 id="4-1-向任意一台服务器发送请求"><a href="#4-1-向任意一台服务器发送请求" class="headerlink" title="4.1 向任意一台服务器发送请求"></a>4.1 向任意一台服务器发送请求</h2><p><a href="http://node3:8983/solr/example/select?q=*%3A*&amp;wt=json&amp;indent=true" target="_blank" rel="noopener">http://node1:8983/solr/example/select?q=*%3A*&amp;wt=json&amp;indent=true</a></p>
<p><a href="http://node4:8983/solr/example/select?q=*%3A*&amp;wt=json&amp;indent=true" target="_blank" rel="noopener">http://node2:8983/solr/example/select?q=*%3A*&amp;wt=json&amp;indent=true</a></p>
<p><a href="http://node5:8983/solr/example/select?q=*%3A*&amp;wt=json&amp;indent=true" target="_blank" rel="noopener">http://node3:8983/solr/example/select?q=*%3A*&amp;wt=json&amp;indent=true</a></p>
<p>其中：example=Collection名称</p>
<img src="/p/d1504f96/8.png" title="错误">
<p> 疑问：集群应该有统一入口地址，不应该区分IP地址。</p>
<h2 id="4-2-访问SolrCloud的过程"><a href="#4-2-访问SolrCloud的过程" class="headerlink" title="4.2 访问SolrCloud的过程"></a>4.2 访问SolrCloud的过程</h2><img src="/p/d1504f96/9.jpg" title="错误">
<p> 在SolrCloud模式下，同一个集群里所有Core的配置都是统一的，Core有leader和replication两种角色，每个core一定属于一个shard，Core在Shard中扮演leader还是replication有Solr使用的Zookeeper自动协调。</p>
<p> 访问SolrCloud的过程是：Solr Client向Zookeeper咨询Collection的地址，Zookeeper返回存活的节点地址供访问，插入数据的时候有SolrCloud内部协调数据分发（内部使用一致性哈希）。</p>
<p> SolrCloud中使用Zookeeper主要实现以下三点功能：（1）集中配置存储以及管理，（2）集群状态改变时进行监控以及通知，（3）shard leader的选举。</p>
<h2 id="4-3-发送http请求的方式"><a href="#4-3-发送http请求的方式" class="headerlink" title="4.3 发送http请求的方式"></a>4.3 发送http请求的方式</h2><h2 id="4-4-客户端API查询方式"><a href="#4-4-客户端API查询方式" class="headerlink" title="4.4 客户端API查询方式"></a>4.4 客户端API查询方式</h2><p>摘自：<a href="http://www.656463.com/article/IvMvQv.htm" target="_blank" rel="noopener">http://www.656463.com/article/IvMvQv.htm</a></p>
<h2 id="4-5-SolrCloud无法使用DIH和MySQL集成"><a href="#4-5-SolrCloud无法使用DIH和MySQL集成" class="headerlink" title="4.5 SolrCloud无法使用DIH和MySQL集成"></a>4.5 SolrCloud无法使用DIH和MySQL集成</h2><p> 使用福建测试环境下&quot;Solr单实例集成MySQL的配置文件&quot;做模板重新创建新的collection对象example2。</p>
<p> 福建配置文件上传到node1的目录下/usr/local/src/solr-5.4.0/server/solr/configsets，作为example2的模板如下图：</p>
<img src="/p/d1504f96/10.png" title="错误">

<p>在node1，node2，node3所有节点执行如下操作：</p>
<table>
<thead>
<tr>
<th>(1)将solr-dataimporthandler-5.4.0.jar从solr/dist/文件夹下copy到solr/server/solr-webapp/webapp/WEB-INF/lib当中，此java包是导入数据用的。(2)从mysql官网中下载一个mysql-connector-java-5.1.34.zip压缩包，解压出一个mysql-connector-java-5.1.35-bin.jar包，将它copy到solr/server/lib下。</th>
</tr>
</thead>
</table>
<p>在node1上创建example2：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 solr]<span class="comment"># ./bin/solr create\_collection -c example2 -d server/solr/configsets/fj\_collection/conf/  -shards 3 -replicationFactor 2</span></span><br></pre></td></tr></table></figure>

<p>页面验证：</p>
<img src="/p/d1504f96/11.png" title="错误">

<p>为MySQL数据创建索引</p>
<blockquote>
<p>solrtest1</p>
</blockquote>
<img src="/p/d1504f96/12.png" title="错误">

<blockquote>
<p>solrtest2 </p>
</blockquote>
<img src="/p/d1504f96/13.png" title="错误">


<p>创建索引有问题</p>
<img src="/p/d1504f96/14.png" title="错误">
<p> 试验结果不成功，只能查到部分数据。</p>
<h2 id="4-6-SolrCloud提供的URl命令"><a href="#4-6-SolrCloud提供的URl命令" class="headerlink" title="4.6 SolrCloud提供的URl命令"></a>4.6 SolrCloud提供的URl命令</h2><p>摘自：<a href="http://www.wtoutiao.com/p/15fprvf.html" target="_blank" rel="noopener">http://www.wtoutiao.com/p/15fprvf.html</a></p>
<ol>
<li><p>//查看zk里面的有多少个collection</p>
</li>
<li><p><a href="http://node1:8983/solr/admin/configs?action=LIST&amp;wt=json" target="_blank" rel="noopener">http://node1:8983/solr/admin/configs?action=LIST&amp;wt=json</a></p>
</li>
</ol>
<p>返回：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">"responseHeader"</span>:&#123;<span class="attr">"status"</span>:<span class="number">0</span>,<span class="attr">"QTime"</span>:<span class="number">45</span>&#125;,<span class="attr">"configSets"</span>:[<span class="string">"example2"</span>,<span class="string">"collection"</span>,<span class="string">"example"</span>,<span class="string">"test"</span>,<span class="string">"myconf"</span>]&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>//</li>
<li><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://localhost:8983/solr/admin/configs?action=DELETE\&amp;amp;name=big\_search</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>摘自：<a href="https://cwiki.apache.org/confluence/display/solr/Collections+API" target="_blank" rel="noopener">https://cwiki.apache.org/confluence/display/solr/Collections+API</a></p>
<p>solrCloud提供了collection管理的url命令。</p>
<h2 id="4-7-SolrCloud提供Client-API"><a href="#4-7-SolrCloud提供Client-API" class="headerlink" title="4.7 SolrCloud提供Client API"></a>4.7 SolrCloud提供Client API</h2><p>Solr提供了多种Client API，摘自：<a href="https://cwiki.apache.org/confluence/display/solr/Client+APIs" target="_blank" rel="noopener">https://cwiki.apache.org/confluence/display/solr/Client+APIs</a></p>
<img src="/p/d1504f96/15.png" title="错误">
<p>有人推荐：spring-data-solr</p>
<h2 id="4-8-SolrJ-5-4-0-客户端库"><a href="#4-8-SolrJ-5-4-0-客户端库" class="headerlink" title="4.8 SolrJ-5.4.0 客户端库"></a>4.8 SolrJ-5.4.0 客户端库</h2><p> 摘自：<a href="https://cwiki.apache.org/confluence/display/solr/Using+SolrJ" target="_blank" rel="noopener">https://cwiki.apache.org/confluence/display/solr/Using+SolrJ</a></p>
<p>maven配置</p>
<table>
<thead>
<tr>
<th>&amp;lt;dependency&amp;gt;  &amp;lt;groupId&amp;gt;org.apache.solr&amp;lt;/groupId&amp;gt;  &amp;lt;artifactId&amp;gt;solr-solrj&amp;lt;/artifactId&amp;gt;  &amp;lt;version&amp;gt;x.y.z&amp;lt;/version&amp;gt;&amp;lt;/dependency&amp;gt;</th>
</tr>
</thead>
</table>
<p>在solr安装文件夹中自带了solrj库的包，如下图：</p>
<img src="/p/d1504f96/16.png" title="错误">
<h3 id="4-8-1-SolrJ连接SolrCloud进行查询"><a href="#4-8-1-SolrJ连接SolrCloud进行查询" class="headerlink" title="4.8.1 SolrJ连接SolrCloud进行查询"></a>4.8.1 SolrJ连接SolrCloud进行查询</h3><p> 逻辑：SolrCloud部署三个节点上（node1，node2，node3），SolrJ通过zookeeper集群选举出SolrCloud中的一个leader节点，然后向该leader节点查询关键字。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">**<span class="keyword">public</span>**** <span class="class"><span class="keyword">class</span> **<span class="title">SolrCloudTest</span> </span>&#123;       ** <span class="keyword">private</span> **CloudSolrClient cloudSolrServer =** <span class="keyword">null</span> **;       ** <span class="keyword">public</span>**<span class="function">CloudSolrClient <span class="title">getCloudSolrServer</span><span class="params">(**<span class="keyword">final</span>**String zkHost)</span> </span>&#123;                cloudSolrServer =**<span class="keyword">new</span>**CloudSolrClient(zkHost);               **<span class="keyword">return</span> **cloudSolrServer;        &#125;        <span class="comment">// 根据关键字查询索引结果       ** public ****void** search(CloudSolrClient solrServer, String String) &#123;                SolrQuery query = **new** SolrQuery();                query.setQuery(String);                **try** &#123;                        QueryResponse response = solrServer.query(query);                        SolrDocumentList docs = response.getResults();                         System._out_.println(&amp;quot;文档个数：&amp;quot; + docs.getNumFound());                        System._out_.println(&amp;quot;查询时间：&amp;quot; + response.getQTime());                         **for** (SolrDocument doc : docs) &#123;                                /\*\*                                \* 每个doc的结构 \&amp;lt;str name=&amp;quot;id&amp;quot;\&amp;gt;solrtest1\_3\&amp;lt;/str\&amp;gt;                                \* \&amp;lt;str name=&amp;quot;detail&amp;quot;\&amp;gt;李四睡觉\&amp;lt;/str\&amp;gt;                                \* \&amp;lt;str name=&amp;quot;tabletag&amp;quot;\&amp;gt;solrtest1\&amp;lt;/str\&amp;gt;                                \* \&amp;lt;str name=&amp;quot;position&amp;quot;\&amp;gt;25.09,116.2\&amp;lt;/str\&amp;gt;                                \* \&amp;lt;long name=&amp;quot;\_version\_&amp;quot;\&amp;gt;1528509412933632000\&amp;lt;/long\&amp;gt;                                \*/                                String id = (String) doc.getFieldValue(&amp;quot;id&amp;quot;);                                String detail = (String) doc.getFieldValue(&amp;quot;detail&amp;quot;);                                String tabletag = (String) doc.getFieldValue(&amp;quot;tabletag&amp;quot;);                                String position = (String) doc.getFieldValue(&amp;quot;position&amp;quot;);                                System._out_.println(&amp;quot;id=&amp;quot; + id + &amp;quot;, detail=&amp;quot; + detail                                                + &amp;quot;, tabletag=&amp;quot; + tabletag + &amp;quot;, position=&amp;quot; + position);                        &#125;                &#125; **catch** (SolrServerException e) &#123;                        e.printStackTrace();                &#125; **catch** (Exception e) &#123;                        System._out_.println(&amp;quot;Unknowned Exception!!!!&amp;quot;);                        e.printStackTrace();                &#125;        &#125;        /\*\*        \* **@param** args        \*/        **public**** static ****void** main(String[] args) &#123;                 String zkHost = &amp;quot;172.16.2.100:2181,172.16.2.101:2181,172.16.2.102:2181&amp;quot;;                **final** String defaultCollection = &amp;quot;example2&amp;quot;;                **final**** int **zkClientTimeout = 20000;               ** final ****int** zkConnectTimeout = 1000;                 **try** &#123;                        SolrCloudTest test = **new** SolrCloudTest();                        CloudSolrClient cloudSolrServer = test.getCloudSolrServer(zkHost);                         System._out_.println(&amp;quot;The Cloud SolrServer Instance has benn created!&amp;quot;);                        cloudSolrServer.setDefaultCollection(defaultCollection);                        cloudSolrServer.setZkClientTimeout(zkClientTimeout);                        cloudSolrServer.setZkConnectTimeout(zkConnectTimeout);                        cloudSolrServer.connect();                        System._out_.println(&amp;quot;The cloud Server has been connected !!!!&amp;quot;);                        test.search(cloudSolrServer, &amp;quot;\*:\*&amp;quot;);                        cloudSolrServer.shutdown();                        System._out_.println(&amp;quot;测试结束&amp;quot;);                &#125; **catch** (Exception e) &#123;                        e.printStackTrace();                &#125;        &#125;&#125;</span></span><br></pre></td></tr></table></figure>

<p>| — |</p>
<p><strong>查询结果:</strong></p>
<table>
<thead>
<tr>
<th>文档个数：2查询时间：70id=solrtest1_3, detail=李四睡觉, tabletag=solrtest1, position=25.09,116.2id=solrtest3_4, detail=赵六, tabletag=solrtest3, position=25.1,116.11测试结束</th>
</tr>
</thead>
</table>
<h3 id="4-8-2-SolrJ连接SolrCloud创建索引"><a href="#4-8-2-SolrJ连接SolrCloud创建索引" class="headerlink" title="4.8.2 SolrJ连接SolrCloud创建索引"></a>4.8.2 SolrJ连接SolrCloud创建索引</h3><img src="/p/d1504f96/17.png" title="错误">
<p>1.</p>
<h1 id="5-异常"><a href="#5-异常" class="headerlink" title="5.异常"></a>5.异常</h1><h2 id="5-1-This-IndexSchema-is-not-mutable"><a href="#5-1-This-IndexSchema-is-not-mutable" class="headerlink" title="5.1 This IndexSchema is not mutable"></a>5.1 This IndexSchema is not mutable</h2><img src="/p/d1504f96/18.png" title="错误">
<img src="/p/d1504f96/19.png" title="错误">

<p>摘自：<a href="http://stackoverflow.com/questions/31719955/solr-error-this-indexschema-is-not-mutable" target="_blank" rel="noopener">http://stackoverflow.com/questions/31719955/solr-error-this-indexschema-is-not-mutable</a></p>
<p>在  <strong>solrConfig.xml中删除如下配置：原因是不允许手动添加ｆｉｅｌｄ</strong></p>
<table>
<thead>
<tr>
<th>&amp;lt;!–     &amp;lt;processor class=&quot;solr.AddSchemaFieldsUpdateProcessorFactory&quot;&amp;gt;      &amp;lt;str name=&quot;defaultFieldType&quot;&amp;gt;strings&amp;lt;/str&amp;gt;      &amp;lt;lst name=&quot;typeMapping&quot;&amp;gt;        &amp;lt;str name=&quot;valueClass&quot;&amp;gt;java.lang.Boolean&amp;lt;/str&amp;gt;        &amp;lt;str name=&quot;fieldType&quot;&amp;gt;booleans&amp;lt;/str&amp;gt;      &amp;lt;/lst&amp;gt;      &amp;lt;lst name=&quot;typeMapping&quot;&amp;gt;        &amp;lt;str name=&quot;valueClass&quot;&amp;gt;java.util.Date&amp;lt;/str&amp;gt;        &amp;lt;str name=&quot;fieldType&quot;&amp;gt;tdates&amp;lt;/str&amp;gt;      &amp;lt;/lst&amp;gt;      &amp;lt;lst name=&quot;typeMapping&quot;&amp;gt;        &amp;lt;str name=&quot;valueClass&quot;&amp;gt;java.lang.Long&amp;lt;/str&amp;gt;        &amp;lt;str name=&quot;valueClass&quot;&amp;gt;java.lang.Integer&amp;lt;/str&amp;gt;        &amp;lt;str name=&quot;fieldType&quot;&amp;gt;tlongs&amp;lt;/str&amp;gt;      &amp;lt;/lst&amp;gt;      &amp;lt;lst name=&quot;typeMapping&quot;&amp;gt;        &amp;lt;str name=&quot;valueClass&quot;&amp;gt;java.lang.Number&amp;lt;/str&amp;gt;        &amp;lt;str name=&quot;fieldType&quot;&amp;gt;tdoubles&amp;lt;/str&amp;gt;      &amp;lt;/lst&amp;gt;    &amp;lt;/processor&amp;gt;     –&amp;gt;</th>
</tr>
</thead>
</table>
<h2 id="5-2-PeerSync-core-example-shard3-replica2-url-http-192-168-232-129-8983-solr-ERROR-​-update-log-not-in-ACTIVE-or-REPLAY-state-FSUpdateLog-state-BUFFERING-​-tlog-null"><a href="#5-2-PeerSync-core-example-shard3-replica2-url-http-192-168-232-129-8983-solr-ERROR-​-update-log-not-in-ACTIVE-or-REPLAY-state-FSUpdateLog-state-BUFFERING-​-tlog-null" class="headerlink" title="5.2 PeerSync: core=example_shard3_replica2 url=http://192.168.232.129:8983/solr ERROR,​ update log not in ACTIVE or REPLAY state. FSUpdateLog{state=BUFFERING,​ tlog=null}"></a>5.2 PeerSync: core=example_shard3_replica2 url=<a href="http://192.168.232.129:8983/solr" target="_blank" rel="noopener">http://192.168.232.129:8983/solr</a> ERROR,​ update log not in ACTIVE or REPLAY state. FSUpdateLog{state=BUFFERING,​ tlog=null}</h2><img src="/p/d1504f96/20.png" title="错误">

<h2 id="5-3-配置文件缺失admin-extra-menu-bottom-html、admin-extra-menu-top-html、admin-extra-html"><a href="#5-3-配置文件缺失admin-extra-menu-bottom-html、admin-extra-menu-top-html、admin-extra-html" class="headerlink" title="5.3 配置文件缺失admin-extra.menu-bottom.html、admin-extra.menu-top.html、admin-extra.html"></a>5.3 配置文件缺失admin-extra.menu-bottom.html、admin-extra.menu-top.html、admin-extra.html</h2><img src="/p/d1504f96/21.png" title="错误">
<p>解决方法：在conf文件夹中创建以上三个空文件即可，这些文件是Solr admin管理页面需要的。摘自：<a href="http://stackoverflow.com/questions/26597813/how-can-i-get-rid-of-can-not-find-admin-extra-html-error" target="_blank" rel="noopener">http://stackoverflow.com/questions/26597813/how-can-i-get-rid-of-can-not-find-admin-extra-html-error</a></p>
<h2 id="5-4-bad-request"><a href="#5-4-bad-request" class="headerlink" title="5.4 bad request"></a>5.4 bad request</h2><img src="/p/d1504f96/22.png" title="错误">
<p>1.</p>
<h1 id="6-单机SolrCloud部署流程【成功了】"><a href="#6-单机SolrCloud部署流程【成功了】" class="headerlink" title="6. 单机SolrCloud部署流程【成功了】"></a>6. 单机SolrCloud部署流程【成功了】</h1><h2 id="6-1环境"><a href="#6-1环境" class="headerlink" title="6.1环境"></a>6.1环境</h2><p>Solr5.4升级到新版本Solr5.5</p>
<p>内嵌Zookeeper</p>
<p>借助内嵌ZK实现单机上部署多节点SolrCloud。</p>
<h2 id="6-2配置文件"><a href="#6-2配置文件" class="headerlink" title="6.2配置文件"></a>6.2配置文件</h2><p>在configsets\data_driven_schema_configs\conf文件基础上添加DIH的配置。</p>
<p>新建文件夹</p>
<img src="/p/d1504f96/24.png" title="错误">
<h2 id="6-3-运行命令"><a href="#6-3-运行命令" class="headerlink" title="6.3 运行命令"></a>6.3 运行命令</h2><p>注意不需要执行./bin/solr start –c，启动SolrCloud就可以直接执行如下步骤。</p>
<img src="/p/d1504f96/25.png" title="步骤">
<img src="/p/d1504f96/26.png" title="步骤">
<img src="/p/d1504f96/27.png" title="步骤">
<img src="/p/d1504f96/28.png" title="步骤">
<h2 id="6-4-验证"><a href="#6-4-验证" class="headerlink" title="6.4 验证"></a>6.4 验证</h2><img src="/p/d1504f96/29.png" title="步骤">
<p>导入：</p>
<img src="/p/d1504f96/30.png" title="步骤">
<p>查询：</p>
<img src="/p/d1504f96/31.png" title="步骤">
<p>运行日志没有任何错误；</p>
<img src="/p/d1504f96/32.png" title="步骤">
<h2 id="6-5-重启服务"><a href="#6-5-重启服务" class="headerlink" title="6.5 重启服务"></a>6.5 重启服务</h2><p>由于 上面创建的是范例程序，所以启动命令如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@node3 solr-5.5.0]<span class="comment">#  ./bin/solr start -e cloud -noprompt</span></span><br></pre></td></tr></table></figure>

<img src="/p/d1504f96/33.png" title="步骤">
<p>1.</p>
<h1 id="7-多机SolrCloud部署流程-成功"><a href="#7-多机SolrCloud部署流程-成功" class="headerlink" title="7. 多机SolrCloud部署流程[成功]"></a>7. 多机SolrCloud部署流程[成功]</h1><h2 id="7-1-环境"><a href="#7-1-环境" class="headerlink" title="7.1 环境"></a>7.1 环境</h2><p>版本Solr5.5</p>
<p>三节点Solr+三节点Zookeeper，搭建SolrCloud。</p>
<p> 为了不影响node3上已经成功的单节点SolrCloud，故保留源文件夹/usr/local/src/solr-5.5.0。</p>
<p> 多节点部署的文件夹使用/usr/local/src/solr-5.5.0-2。</p>
<p> 必须jdk1.7以上</p>
<h2 id="7-2-配置文件"><a href="#7-2-配置文件" class="headerlink" title="7.2 配置文件"></a>7.2 配置文件</h2><p>在configsets\data_driven_schema_configs\conf文件基础上添加DIH的配置。</p>
<p>在如下位置新建文件夹</p>
<img src="/p/d1504f96/34.png" title="步骤">
<h2 id="7-2-jar包"><a href="#7-2-jar包" class="headerlink" title="7.2 jar包"></a>7.2 jar包</h2><p>【1】将solr-dataimporthandler-5.5.0.jar和solr-dataimporthandler-extras-5.5.0.jar从solr/dist/文件夹下copy到solr/server/solr-webapp/webapp/WEB-INF/lib当中，此java包是导入数据用的。</p>
<p>【2】从mysql官网中下载一个mysql-connector-java-5.1.35.zip压缩包，解压出一个mysql-connector-java-5.1.35-bin.jar包，将它copy到solr/server/lib下。</p>
<h2 id="6-3-启动ZK集群"><a href="#6-3-启动ZK集群" class="headerlink" title="6.3 启动ZK集群"></a>6.3 启动ZK集群</h2><h2 id="6-4-运行命令"><a href="#6-4-运行命令" class="headerlink" title="6.4 运行命令"></a>6.4 运行命令</h2><p>启动solrcloud</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 solr]<span class="comment"># ./bin/solr start -c -z node1:2181,node2:2181,node3:2181</span></span><br><span class="line"></span><br><span class="line">[root@node2 solr]<span class="comment"># ./bin/solr start -c -z node1:2181,node2:2181,node3:2181</span></span><br><span class="line"></span><br><span class="line">[root@node3 solr]<span class="comment"># ./bin/solr start -c -z node1:2181,node2:2181,node3:2181</span></span><br></pre></td></tr></table></figure>

<img src="/p/d1504f96/35.png" title="步骤">
<p>在node1节点执行如下命令：</p>
<p>| 当创建collection出现异常时执行如下命令： </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./server/scripts/cloud-scripts/zkcli.sh -cmd upconfig -confdir ./server/solr/configsets/fj\_collection/conf -confname myconf -z node1:2181,node2:2181,node3:2181 ./server/scripts/cloud-scripts/zkcli.sh -cmd linkconfig -collection gettingstarted -confname myconf -z node1:2181,node2:2181,node3:2181</span><br></pre></td></tr></table></figure>

<p>创建名称为gettingstarted2 的collection</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bin/solr create\_collection -c gettingstarted2 -d ./server/solr/configsets/fj\_collection/conf/ -shards 3 -replicationFactor 2</span><br></pre></td></tr></table></figure>

<p>创建名称为bjtcda的collection</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bin/solr create\_collection -c bjtcda<span class="_">-d</span> ./server/solr/configsets/fj\_collection/conf/ -shards 3 -replicationFactor 2 |</span><br></pre></td></tr></table></figure>

<p>| — |</p>
<p>导入数据</p>
<img src="/p/d1504f96/36.png" title="步骤">
<p>验证</p>
<img src="/p/d1504f96/37.png" title="步骤">
<p>查询</p>
<img src="/p/d1504f96/38.png" title="步骤">
<p>后台不报错</p>
<img src="/p/d1504f96/39.png" title="步骤">
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bin/solr create\_collection -c gettingstarted3 -d ./server/solr/configsets/fj\_collection/conf/ -shards 3 -replicationFactor 2</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/p/74d3977b/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="阿深">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/head3.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="阿深">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/p/74d3977b/" itemprop="url">Yii2创建管理员登录</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-09-14T22:13:00+08:00">
                2017-09-14
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/后端/" itemprop="url" rel="index">
                    <span itemprop="name">后端</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/后端/PHP/" itemprop="url" rel="index">
                    <span itemprop="name">PHP</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h5 id="1-创建管理员表"><a href="#1-创建管理员表" class="headerlink" title="1. 创建管理员表"></a>1. 创建管理员表</h5><p>进入项目根目录，在根目录执行命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ./yii migrate</span><br></pre></td></tr></table></figure>

<h5 id="2-创建管理的控制器"><a href="#2-创建管理的控制器" class="headerlink" title="2. 创建管理的控制器"></a>2. 创建管理的控制器</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> console/controllers/</span><br></pre></td></tr></table></figure>

<p>  编写代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">console</span>\<span class="title">controllers</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">common</span>\<span class="title">models</span>\<span class="title">UserLoginToken</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Yii</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">yii</span>\<span class="title">console</span>\<span class="title">Controller</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">common</span>\<span class="title">models</span>\<span class="title">User</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">InitController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Create init user</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">actionAdmin</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"创建一个新用户 ...\n"</span>;<span class="comment">// 提示当前操作</span></span><br><span class="line">        $username = <span class="keyword">$this</span>-&gt;prompt(<span class="string">'User Name:'</span>); <span class="comment">// 接收用户名</span></span><br><span class="line">        $email = <span class="keyword">$this</span>-&gt;prompt(<span class="string">'Email:'</span>); <span class="comment">// 接收Email</span></span><br><span class="line">        $password = <span class="keyword">$this</span>-&gt;prompt(<span class="string">'Password:'</span>);<span class="comment">// 接收密码</span></span><br><span class="line">        $model = <span class="keyword">new</span> User(); <span class="comment">// 创建一个新用户</span></span><br><span class="line">        $model-&gt;username = $username; <span class="comment">// 完成赋值</span></span><br><span class="line">        $model-&gt;email = $email; <span class="comment">// 完成赋值</span></span><br><span class="line">        $model-&gt;generateAuthKey();</span><br><span class="line">        $model-&gt;generatePasswordResetToken();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 在读取和写入对象的一个不存在的成员变量时， __get() __set() 会被自动调用。 Yii正是利用这点，提供对属性的支持的。从上面的代码中，</span></span><br><span class="line"><span class="comment">         * 可以看出，如果访问一个对象的某个属性， Yii会调用名为 get属性名() 的函数。如， $model-&gt;password ， 会自动调用 $model-&gt;setPassword() 。</span></span><br><span class="line"><span class="comment">         * 如果修改某一属性，会调用相应的setter函数。</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        $model-&gt;password = $password;</span><br><span class="line">        <span class="comment">// 保存新的用户</span></span><br><span class="line">        <span class="keyword">if</span> (!$model-&gt;save()) &#123;</span><br><span class="line">            <span class="comment">// 如果保存失败，说明有错误，那就输出错误信息。</span></span><br><span class="line">            <span class="keyword">foreach</span> ($model-&gt;getErrors() <span class="keyword">as</span> $error) &#123;</span><br><span class="line">                <span class="keyword">foreach</span> ($error <span class="keyword">as</span> $e) &#123;</span><br><span class="line">                    <span class="keyword">echo</span> <span class="string">"$e\n"</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>; <span class="comment">// 命令行返回1表示有异常</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>; <span class="comment">// 返回0表示一切OK</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="3-执行脚本"><a href="#3-执行脚本" class="headerlink" title="3. 执行脚本"></a>3. 执行脚本</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ./yii init/admin</span><br></pre></td></tr></table></figure>

<p> 然后分别输入帐户、Email、登录密码，完成创建。<br> <img src="/p/74d3977b/yii2-01.png" title="示例"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/p/cf2023e4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="阿深">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/head3.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="阿深">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/p/cf2023e4/" itemprop="url">mysql：精妙SQL语句</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-29T15:05:30+08:00">
                2017-06-29
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/后端/" itemprop="url" rel="index">
                    <span itemprop="name">后端</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/后端/mysql/" itemprop="url" rel="index">
                    <span itemprop="name">mysql</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>统计某个字段出现数量最多</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * , <span class="keyword">COUNT</span>( * ) <span class="keyword">AS</span> <span class="keyword">count</span></span><br><span class="line"><span class="keyword">FROM</span> ext_read_history</span><br><span class="line"><span class="keyword">WHERE</span> cat_id =<span class="number">10</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> content_id</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">count</span> <span class="keyword">DESC</span> </span><br><span class="line"><span class="keyword">LIMIT</span> <span class="number">20</span>;</span><br></pre></td></tr></table></figure>

<p>说明：复制表(只复制结构,源表名：a 新表名：b) </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">into</span> b <span class="keyword">from</span> a <span class="keyword">where</span> <span class="number">1</span>&lt;&gt;<span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>说明：拷贝表(拷贝数据,源表名：a 目标表名：b) </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> b(a, b, c) <span class="keyword">select</span> d,e,f <span class="keyword">from</span> b;</span><br></pre></td></tr></table></figure>

<p>说明：显示文章、提交人和最后回复时间 </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> a.title,a.username,b.adddate <span class="keyword">from</span> <span class="keyword">table</span> a,(<span class="keyword">select</span> <span class="keyword">max</span>(adddate) adddate <span class="keyword">from</span> <span class="keyword">table</span> <span class="keyword">where</span> table.title=a.title) b</span><br></pre></td></tr></table></figure>

<p>说明：外连接查询(表名1：a 表名2：b) </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> a.a, a.b, a.c, b.c, b.d, b.f <span class="keyword">from</span> a <span class="keyword">LEFT</span> <span class="keyword">OUT</span> <span class="keyword">JOIN</span> b <span class="keyword">ON</span> a.a = b.c</span><br></pre></td></tr></table></figure>

<p>说明：日程安排提前五分钟提醒 </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> 日程安排 <span class="keyword">where</span> <span class="keyword">datediff</span>(<span class="string">'minute'</span>,f开始时间,<span class="keyword">getdate</span>())&gt;<span class="number">5</span></span><br></pre></td></tr></table></figure>

<p>说明：两张关联表，删除主表中已经在副表中没有的信息 </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> info <span class="keyword">where</span> <span class="keyword">not</span> <span class="keyword">exists</span> ( <span class="keyword">select</span> * <span class="keyword">from</span> infobz <span class="keyword">where</span> info.infid=infobz.infid )</span><br></pre></td></tr></table></figure>

<p>说明：– </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> A.NUM, A.NAME, B.UPD_DATE, B.PREV_UPD_DATE </span><br><span class="line"><span class="keyword">FROM</span> TABLE1, </span><br><span class="line">(<span class="keyword">SELECT</span> X.NUM, X.UPD_DATE, Y.UPD_DATE PREV_UPD_DATE </span><br><span class="line"><span class="keyword">FROM</span> (<span class="keyword">SELECT</span> <span class="keyword">NUM</span>, UPD_DATE, INBOUND_QTY, STOCK_ONHAND </span><br><span class="line"><span class="keyword">FROM</span> TABLE2 </span><br><span class="line"><span class="keyword">WHERE</span> TO_CHAR(UPD_DATE,<span class="string">'YYYY/MM'</span>) = TO_CHAR(<span class="keyword">SYSDATE</span>, <span class="string">'YYYY/MM'</span>)) X, </span><br><span class="line">(<span class="keyword">SELECT</span> <span class="keyword">NUM</span>, UPD_DATE, STOCK_ONHAND </span><br><span class="line"><span class="keyword">FROM</span> TABLE2 </span><br><span class="line"><span class="keyword">WHERE</span> TO_CHAR(UPD_DATE,<span class="string">'YYYY/MM'</span>) = </span><br><span class="line">TO_CHAR(<span class="keyword">TO_DATE</span>(TO_CHAR(<span class="keyword">SYSDATE</span>, <span class="string">'YYYY/MM'</span>) &amp;&amp; <span class="string">'/01'</span>,<span class="string">'YYYY/MM/DD'</span>) - <span class="number">1</span>, <span class="string">'YYYY/MM'</span>) ) Y, </span><br><span class="line"><span class="keyword">WHERE</span> X.NUM = Y.NUM （+） </span><br><span class="line"><span class="keyword">AND</span> X.INBOUND_QTY + NVL(Y.STOCK_ONHAND,<span class="number">0</span>) &lt;&gt; X.STOCK_ONHAND ) B </span><br><span class="line"><span class="keyword">WHERE</span> A.NUM = B.NUM</span><br></pre></td></tr></table></figure>

<p>说明：– </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> studentinfo <span class="keyword">where</span> <span class="keyword">not</span> <span class="keyword">exists</span>(<span class="keyword">select</span> * <span class="keyword">from</span> student <span class="keyword">where</span> studentinfo.id=student.id) <span class="keyword">and</span> 系名称=<span class="string">'"&amp;strdepartmentname&amp;"'</span> <span class="keyword">and</span> 专业名称=<span class="string">'"&amp;strprofessionname&amp;"'</span> <span class="keyword">order</span> <span class="keyword">by</span> 性别,生源地,高考总成绩 </span><br><span class="line">说明：从数据库中去一年的各单位电话费统计(电话费定额贺电化肥清单两个表来源）</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> a.userper, a.tel, a.standfee, TO_CHAR(a.telfeedate, <span class="string">'yyyy'</span>) <span class="keyword">AS</span> telyear, </span><br><span class="line"><span class="keyword">SUM</span>(<span class="keyword">decode</span>(TO_CHAR(a.telfeedate, <span class="string">'mm'</span>), <span class="string">'01'</span>, a.factration)) <span class="keyword">AS</span> JAN, </span><br><span class="line"><span class="keyword">SUM</span>(<span class="keyword">decode</span>(TO_CHAR(a.telfeedate, <span class="string">'mm'</span>), <span class="string">'02'</span>, a.factration)) <span class="keyword">AS</span> FRI, </span><br><span class="line"><span class="keyword">SUM</span>(<span class="keyword">decode</span>(TO_CHAR(a.telfeedate, <span class="string">'mm'</span>), <span class="string">'03'</span>, a.factration)) <span class="keyword">AS</span> MAR, </span><br><span class="line"><span class="keyword">SUM</span>(<span class="keyword">decode</span>(TO_CHAR(a.telfeedate, <span class="string">'mm'</span>), <span class="string">'04'</span>, a.factration)) <span class="keyword">AS</span> APR, </span><br><span class="line"><span class="keyword">SUM</span>(<span class="keyword">decode</span>(TO_CHAR(a.telfeedate, <span class="string">'mm'</span>), <span class="string">'05'</span>, a.factration)) <span class="keyword">AS</span> MAY, </span><br><span class="line"><span class="keyword">SUM</span>(<span class="keyword">decode</span>(TO_CHAR(a.telfeedate, <span class="string">'mm'</span>), <span class="string">'06'</span>, a.factration)) <span class="keyword">AS</span> JUE, </span><br><span class="line"><span class="keyword">SUM</span>(<span class="keyword">decode</span>(TO_CHAR(a.telfeedate, <span class="string">'mm'</span>), <span class="string">'07'</span>, a.factration)) <span class="keyword">AS</span> JUL, </span><br><span class="line"><span class="keyword">SUM</span>(<span class="keyword">decode</span>(TO_CHAR(a.telfeedate, <span class="string">'mm'</span>), <span class="string">'08'</span>, a.factration)) <span class="keyword">AS</span> AGU, </span><br><span class="line"><span class="keyword">SUM</span>(<span class="keyword">decode</span>(TO_CHAR(a.telfeedate, <span class="string">'mm'</span>), <span class="string">'09'</span>, a.factration)) <span class="keyword">AS</span> SEP, </span><br><span class="line"><span class="keyword">SUM</span>(<span class="keyword">decode</span>(TO_CHAR(a.telfeedate, <span class="string">'mm'</span>), <span class="string">'10'</span>, a.factration)) <span class="keyword">AS</span> <span class="keyword">OCT</span>, </span><br><span class="line"><span class="keyword">SUM</span>(<span class="keyword">decode</span>(TO_CHAR(a.telfeedate, <span class="string">'mm'</span>), <span class="string">'11'</span>, a.factration)) <span class="keyword">AS</span> NOV, </span><br><span class="line"><span class="keyword">SUM</span>(<span class="keyword">decode</span>(TO_CHAR(a.telfeedate, <span class="string">'mm'</span>), <span class="string">'12'</span>, a.factration)) <span class="keyword">AS</span> <span class="built_in">DEC</span> </span><br><span class="line"><span class="keyword">FROM</span> (<span class="keyword">SELECT</span> a.userper, a.tel, a.standfee, b.telfeedate, b.factration </span><br><span class="line"><span class="keyword">FROM</span> TELFEESTAND a, TELFEE b </span><br><span class="line"><span class="keyword">WHERE</span> a.tel = b.telfax) a </span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> a.userper, a.tel, a.standfee, TO_CHAR(a.telfeedate, <span class="string">'yyyy'</span>) ;</span><br></pre></td></tr></table></figure>

<p>说明：四表联查问题： </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> a <span class="keyword">left</span> <span class="keyword">inner</span> <span class="keyword">join</span> b <span class="keyword">on</span> a.a=b.b <span class="keyword">right</span> <span class="keyword">inner</span> <span class="keyword">join</span> c <span class="keyword">on</span> a.a=c.c <span class="keyword">inner</span> <span class="keyword">join</span> d <span class="keyword">on</span> a.a=d.d <span class="keyword">where</span> .....</span><br></pre></td></tr></table></figure>

<p>说明：得到表中最小的未使用的ID号 </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> (<span class="keyword">CASE</span> <span class="keyword">WHEN</span> <span class="keyword">EXISTS</span>(<span class="keyword">SELECT</span> * <span class="keyword">FROM</span> Handle b <span class="keyword">WHERE</span> b.HandleID = <span class="number">1</span>) <span class="keyword">THEN</span> <span class="keyword">MIN</span>(HandleID) + <span class="number">1</span> <span class="keyword">ELSE</span> <span class="number">1</span> <span class="keyword">END</span>) <span class="keyword">as</span> HandleID </span><br><span class="line"><span class="keyword">FROM</span> Handle </span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">NOT</span> HandleID <span class="keyword">IN</span> (<span class="keyword">SELECT</span> a.HandleID - <span class="number">1</span> <span class="keyword">FROM</span> Handle a)</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/p/6d5007a7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="阿深">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/head3.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="阿深">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/p/6d5007a7/" itemprop="url">AJAX跨域请求、CORS 跨域发送 Cookie</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-05-15T16:06:48+08:00">
                2017-05-15
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/前端/" itemprop="url" rel="index">
                    <span itemprop="name">前端</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/前端/javascript/" itemprop="url" rel="index">
                    <span itemprop="name">javascript</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在 Web 页面中可以随意地载入跨域的图片、视频、样式等资源， 但 AJAX 请求通常会被浏览器应用同源安全策略，禁止获取跨域数据，以及限制发送跨域请求。 虽然有多种方法利用资源标签进行跨域，但能够进行的数据交互非常有限。 在 2014 年 W3C 发布了 CORS Recommendation 来允许更方便的跨域资源共享。 默认情况下浏览器对跨域请求不会携带 Cookie，但鉴于 Cookie 在身份验证等方面的重要性， CORS 推荐使用额外的响应头字段来允许跨域发送 Cookie。<br>客户端代码<br>在open XMLHttpRequest后，设置withCredentials为true即可让该跨域请求携带 Cookie。 注意携带的是目标页面所在域的 Cookie。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> xhr = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">xhr.open(<span class="string">'GET'</span>, url);</span><br><span class="line">xhr.withCredentials = <span class="literal">true</span>;</span><br><span class="line">xhr.send();</span><br></pre></td></tr></table></figure>

<p>如果你在使用 jQuery，可以通过xhrFields来设置：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$.ajax(&#123;</span><br><span class="line">   url: a_cross_domain_url,</span><br><span class="line">   xhrFields: &#123;</span><br><span class="line">      withCredentials: <span class="literal">true</span></span><br><span class="line">   &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>如果你在使用 Zepto，抱歉没有办法。因为 Zepto 会在open之前设置withCredentials。 根据WHATWG 的 XHR 标准在open之后设置是不合法的， 虽然多数浏览器不抛出错误但仍然不会携带 Cookie。<br>True when user credentials are to be included in a cross-origin request. False when they are to be excluded in a cross-origin request and when cookies are to be ignored in its response. Initially false. When set: throws an InvalidStateError exception if state is not unsent or opened, or if the send() flag is set. – WHATWG XMLHttpRequest<br>Access-Control-Allow-Credentials<br>只设置客户端当然是没用的，还需要目标服务器接受你跨域发送的 Cookie。 否则会被浏览器的同源策略挡住：</p>
<p>服务器同时设置Access-Control-Allow-Credentials响应头为”true”， 即可允许跨域请求携带 Cookie。<br>Access-Control-Allow-Origin<br>除了Access-Control-Allow-Credentials之外，跨域发送 Cookie 还要求 Access-Control-Allow-Origin不允许使用通配符。 事实上不仅不允许通配符，而且只能指定单一域名：<br>If the credentials flag is true and the response includes zero or more than one Access-Control-Allow-Credentials header values return fail and terminate this algorithm. –W3C Cross-Origin Resource Sharing<br>否则，浏览器还是会挡住跨域请求：</p>
<p>计算 Access-Control-Allow-Origin<br>既然Access-Control-Allow-Origin只允许单一域名， 服务器可能需要维护一个接受 Cookie 的 Origin 列表， 验证 Origin 请求头字段后直接将其设置为Access-Control-Allow-Origin的值。 （这一实践来自 Stackoverflow） 值得注意的是在 CORS 请求被重定向后 Origin 头字段会被置为 null。 此时可以选择从Referer头字段计算得到Origin。<br>在正确配置的情况下，在 Chrome Network 就可以看到 Cookie 请求头被跨域发送了 （注意 Host 和Referer不同域，但仍然带了Cookie）：</p>
<figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Accept:*/*</span><br><span class="line">Accept-Encoding:gzip, deflate, sdch, br</span><br><span class="line">Accept-Language:zh-CN,zh;q=0.8,en;q=0.6,nl;q=0.4,zh-TW;q=0.2,fr;q=0.2,de;q=0.2,ja;q=0.2</span><br><span class="line">Connection:keep-alive</span><br><span class="line">Cookie:auhtor:harttle; _gat=1; _ga=GA1.1.221305049.1482947002</span><br><span class="line">Host:dest.com:4001</span><br><span class="line">Origin:http://index.com:4001</span><br><span class="line">Referer:http://index.com:4001/</span><br><span class="line">User-Agent:Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/55.0.2883.95 Safari/537.36</span><br></pre></td></tr></table></figure>

<p>服务器端代码</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> app = express();</span><br><span class="line">app.get(<span class="string">'/specific-allow-origin-with-credentials'</span>, (req, res) =&gt; &#123;</span><br><span class="line">    res.set(&#123;</span><br><span class="line">        <span class="string">'Access-Control-Allow-Origin'</span>: <span class="string">'http://index.com:4001'</span>,</span><br><span class="line">        <span class="string">'Access-Control-Allow-Credentials'</span>: <span class="literal">true</span></span><br><span class="line">    &#125;);</span><br><span class="line">    res.status(<span class="number">200</span>).end(<span class="string">'I got your cookie: '</span> + req.headers.cookie);</span><br><span class="line">&#125;);</span><br><span class="line">app.listen(<span class="number">4001</span>, () =&gt; <span class="built_in">console</span>.log(<span class="string">'listening to 4001'</span>));</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/head3.jpg" alt="阿深">
            
              <p class="site-author-name" itemprop="name">阿深</p>
              <p class="site-description motion-element" itemprop="description">阿深</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">31</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">13</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">33</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2018 &mdash; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">阿深</span>

  
  <a href="http://www.beian.miit.gov.cn">粤ICP备15053509号</a>
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
